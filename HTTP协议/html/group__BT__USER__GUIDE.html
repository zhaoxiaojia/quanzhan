<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACS: Bluetooth Middleware User Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ACS
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__BT__USER__GUIDE.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Bluetooth Middleware User Guide<div class="ingroups"><a class="el" href="group__ACS__CORE__DOCS.html">ACS Core Docs</a> &raquo; <a class="el" href="group__USER__GUIDE.html">Middleware User Guides</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for Bluetooth Middleware User Guide:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__BT__USER__GUIDE.png" border="0" alt="" usemap="#group____BT____USER____GUIDE"/>
<map name="group____BT____USER____GUIDE" id="group____BT____USER____GUIDE">
<area shape="rect" id="node2" href="group__USER__GUIDE.html" title="Middleware User Guides" alt="" coords="5,13,171,39"/>
</map>
</td></tr></table></center>
</div>
<p><b>Version Number:</b> 1.0</p>
<ul>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_1">Introduction</a></li>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_2">Prerequisites</a></li>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_3">Configurations</a></li>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_4">Usage/Best Practices</a></li>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_5">Build Artifacts</a></li>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_6">FAQ</a></li>
<li><a class="el" href="group__BT__USER__GUIDE.html#bt_section_7">References</a></li>
</ul>
<h1><a class="anchor" id="bt_section_1"></a>
Introduction</h1>
<p>ACS Bluetooth middleware (<a class="el" href="group__ACEBT.html">ACE Bluetooth Middleware</a>) provides a common set of APIs to allow multiple applications to utilize a platform's Bluetooth functionality. The Bluetooth middleware invokes ACS Bluetooth HAL (<a class="el" href="group__HAL__BLUETOOTH.html">Bluetooth</a>) interfaces which abstract the underlying Bluetooth Stack or SDK with the radio. Based on the various configurations (Refer to <a class="el" href="group__BT__USER__GUIDE.html#bt_section_3">Configurations</a>), the Bluetooth middleware can be configured for Classic only or Bluetooth Low Energy (BLE) only or Dual mode (Classic and BLE) modes. The diagram below depicts how ACS Bluetooth middleware would be integrated on various Linux/RTOS platforms -</p>
<div class="image">
<img src="acs_bt_middleware.png" alt="ACS Bluetooth Middleware"/>
</div>
<p>The Bluetooth middleware API exposes a set of interfaces that either make internal IPC calls (when ACS is configured to use ACS AIPC) or invoke core middleware routines directly. Each of the sub-modules will have its own "manager" module which (optionally) maintains an internal state machine in order to route the call to HAL via a corresponding HAL manager. Most of the APIs are asynchronous in nature and hence would have a corresponding callback(s) associated with an API routine. Hence, in most cases, applications should implement a callback based invocation of ACS Bluetooth APIs rather than serially invoking them. The following is a logical representation of various Bluetooth middleware modules :</p>
<ul>
<li><a class="el" href="group__ACE__BT__SESSION__API.html">Session Manager APIs for Bluetooth clients</a></li>
<li><a class="el" href="group__ACE__BT__API__COMMON.html">Common/Device-management APIs</a></li>
<li><a class="el" href="group__ACE__BT__API__CLASSIC.html">Classic Bluetooth APIs</a></li>
<li><a class="el" href="group__ACE__BT__SOCKET__API.html">Socket APIs</a></li>
<li><a class="el" href="group__ACE__BLE__API.html">BLE APIs</a><ul>
<li><a class="el" href="group__ACE__BLE__API__COMMON.html">Common APIs</a></li>
<li><a class="el" href="group__ACE__BLE__API__BEACON.html">BLE Beacon Manager APIs</a></li>
<li><a class="el" href="group__ACE__BLE__API__GATT__SERVER.html">GATT Server APIs</a></li>
<li><a class="el" href="group__ACE__BLE__API__GATT__CLIENT.html">GATT Client APIs</a></li>
</ul>
</li>
</ul>
<p>Inorder to support multiple applications to utilize common Bluetooth functionality simultaneously, ACS Bluetooth middleware utilizes a Session Manager (<a class="el" href="group__ACE__BT__SESSION__API.html">Session Manager APIs for Bluetooth clients</a>). Any application is allowed to use bluetooth APIs independent of Bluetooth usage by other applications. In order to achieve the multi-client support, Bluetooth module needs to maintain context of every Bluetooth client module. Client context helps Bluetooth to allow simultaneous usage of radio for different BT operations and route the Bluetooth specific events to appropriate client module based on the unicast, multi-cast and broadcast rules. The management of client module contexts within Bluetooth module is termed as session management. Bluetooth session management is agnostic of process and thread context of the client modules &ndash; i.e. each client using bluetooth will be allocated with a separate session (A Session control block - SCB) irrespective of its process/thread context. The following diagram depicts how different apps can be deployed on a platform running ACS.</p>
<div class="image">
<img src="acs_bt_session.png" alt="ACS Bluetooth Session Manager"/>
</div>
<p>A typical code flow of Session manager with applications is as follows -</p>
<div class="image">
<img src="acs_bt_session_seq.png" alt="ACS Bluetooth Session Manager sequence flow"/>
</div>
<h1><a class="anchor" id="bt_section_2"></a>
Prerequisites</h1>
<ul>
<li>Required HALs:<ul>
<li><a class="el" href="group__ACE__HAL__KV__STORAGE.html">KV Storage</a><ul>
<li>This is used by the middleware's Classic reconnection manager to attempt reconnection logic based on last connection profile on reboot.</li>
</ul>
</li>
<li><a class="el" href="group__HAL__BLUETOOTH.html">Bluetooth HAL</a><ul>
<li>This is used for accessing the underlying Bluetooth radio functionality (HAL abstracts the Bluetooth SDK/Stack)</li>
</ul>
</li>
</ul>
</li>
<li>Required middleware:<ul>
<li>Metrics<ul>
<li>This is used to record Bluetooth metrics</li>
</ul>
</li>
</ul>
</li>
<li>Required DPK components:<ul>
<li>ACE_LOG<ul>
<li>This is used for logging purposes</li>
</ul>
</li>
<li><a class="el" href="group__OSAL.html">OSAL</a><ul>
<li>For OS agnostic primitives</li>
</ul>
</li>
</ul>
</li>
<li>Optional DPK components (Included based on product configuration):<ul>
<li>ACE_AIPC<ul>
<li>This is used for IPC mechanism between ACS Bluetooth APIs and common Bluetooth middleware instance.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="bt_section_3"></a>
Configurations</h1>
<p>ACS Bluetooth middleware allows multiple mandatory and optional configurations that allows platforms to choose the Bluetooth functionalities that are needed.</p>
<ul>
<li><b>ACE_BT_MIDDLEWARE</b> [Mandatory] Main option to enable ACS Bluetooth middleware</li>
<li><b>ACE_BT_CLASSIC_PROFILES_SUPPORT</b> [Mandatory] Enables support for Classic Bluetooth<ul>
<li><b>ACE_BT_HID</b> [Optional] Enables support for HID Host profile</li>
<li><b>ACE_BT_MAX_CONNECTED_DEVICE_COUNT</b> [Optional] Sets the maximum number of connected devices. Defaults to 8.</li>
</ul>
</li>
<li><b>ACE_BT_BLE_SUPPORT</b> [Mandatory] Enables support for Bluetooth Low Energy (BLE). Enabling this configuration will enable common BLE and GATT Server functionality<ul>
<li><b>ACE_BT_GATTC_SUPPORT</b> [Optional] Enables support for GATT Client functionality. Defaults to disabled</li>
<li><b>ACE_BT_LE_BONDING</b> [Optional] Enables LE only bonding. Defaults to disabled</li>
<li><b>ACE_BT_BEACON_MAX_FILTERS</b> [Optional] Limit number of beacon filters an application client can use. Defaults to 3</li>
<li><b>ACE_BT_GATTC_DISC_AT_UNPAIR</b> [Optional] Enables middleware to trigger an explicit GATT Client disconnect before Unpair. Defaults to false</li>
<li><b>ACE_BT_DISABLE_FORCED_ADV_CALLBACK</b> [Optional] Enable middleware to not send additional advertisement state callback apart from HAL triggered one. Useful for platforms that cannot send this callback from HAL layer. Defaults to false</li>
</ul>
</li>
<li><b>ACE_BT_LITE_SUPPORT</b> [Optional] Enables Bluetooth APIs to skip IPC mechanisms and call into middleware core modules directly. This configuration can be enabled on platforms like RTOS where multi-client configurations for Bluetooth is not needed.</li>
<li><b>ACE_BT_CLI_FULL</b> [Optional] By default, the test CLI enables only a subset of CLI options needed to validate Bluetooth functionality. This configuration enables the full CLI options for Bluetooth</li>
<li><b>ACE_BT_MAX_BONDED_DEVICE_COUNT</b> [Optional] Sets the maximum number of bonded device list that Middleware will track. Beyond the max count, the Bluetooth middleware will prevent the device from entering DISCOVERABLE state. Defaults to 32</li>
</ul>
<p>Apart from these high-level configurations, Bluetooth middleware allows further granular control configurations esp for BLE Beacons. Note that to prevent applications to over-complicate the BLE configurations, Bluetooth configuration classifies them into various config groups and allows platforms to set override values for these config groups. Applications will only need to select the different config groups CRITICAL/HIGH/BALANCED/LOW as per their needs. Note that below the following configurations need to be set for the platform only if the default values need to be overridden.</p>
<ul>
<li>BLE Connection Interval :<ul>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_CRITICAL_MIN</b> [Optional] Sets minimum connection interval (in units of 625 ms) for Critical config group. Defaults to 6</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_CRITICAL_MAX</b> [Optional] Sets maximum connection interval (in units of 625 ms) for Critical config group. Defaults to 8</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_HIGH_MIN</b> [Optional] Sets minimum connection interval (in units of 625 ms) for High config group. Defaults to 12</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_HIGH_MAX</b> [Optional] Sets maximum connection interval (in units of 625 ms) for High config group. Defaults to 16</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_BALANCED_MIN</b> [Optional] Sets minimum connection interval (in units of 625 ms) for Balanced config group. Defaults to 80</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_BALANCED_MAX</b> [Optional] Sets maximum connection interval (in units of 625 ms) for Balanced config group. Defaults to 100</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_LOW_MIN</b> [Optional] Sets minimum connection interval (in units of 625 ms) for Low config group. Defaults to 400</li>
<li><b>ACE_BT_BLE_CONNECTION_INTERVAL_LOW_MAX</b> [Optional] Sets maximum connection interval (in units of 625 ms) for Low config group. Defaults to 400</li>
</ul>
</li>
<li>BLE Connection priority timeout :<ul>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_CRITICAL_TIMEOUT</b> [Optional] Sets connection priority timeout (in units of ms) for Critical config group. Defaults to 2000</li>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_HIGH_TIMEOUT</b> [Optional] Sets connection priority timeout (in units of ms) for High config group. Defaults to 2000</li>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_BALANCED_TIMEOUT</b> [Optional] Sets connection priority timeout (in units of ms) for Balanced config group. Defaults to 2000</li>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_LOW_TIMEOUT</b> [Optional] Sets connection priority timeout (in units of ms) for Low config group. Defaults to 2000</li>
</ul>
</li>
<li>BLE Connection priority latency :<ul>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_CRITICAL_LATENCY</b> [Optional] Sets connection priority latency for Critical config group. Defaults to 0</li>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_HIGH_LATENCY</b> [Optional] Sets connection priority for High config group. Defaults to 0</li>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_BALANCED_LATENCY</b> [Optional] Sets connection priority for Balanced config group. Defaults to 0</li>
<li><b>ACE_BT_BLE_CONNECTION_PRIORITY_LOW_LATENCY</b> [Optional] Sets connection priority for Low config group. Defaults to 2</li>
</ul>
</li>
<li>Beacon advertisement interval :<ul>
<li><b>ACE_BT_BEACON_ULTRA_LOW_LATENCY_INTERVAL</b> [Optional] Sets Beacon Advertisement Interval for Very High power/Ultra Low Latency mode. Defaults to 20</li>
<li><b>ACE_BT_BEACON_LOW_LATENCY_INTERVAL</b> [Optional] Sets Beacon Advertisement Interval for High power/Low Latency mode. Defaults to 100</li>
<li><b>ACE_BT_BEACON_BALANCED_INTERVAL</b> [Optional] Sets Beacon Advertisement Interval for Balanced Latency mode. Defaults to 250</li>
<li><b>ACE_BT_BEACON_LOW_POWER_INTERVAL</b> [Optional] Sets Beacon Advertisement Interval for Low power/High Latency mode. Defaults to 1000</li>
</ul>
</li>
<li>Beacon device appearance :<ul>
<li><b>ACE_BT_BLE_DEVICE_APPEARANCE</b> [Optional] Sets the default appearance for BLE Beacon. Defaults to 0</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="bt_section_4"></a>
Usage/Best Practices</h1>
<p>As described in <a class="el" href="group__BT__USER__GUIDE.html#bt_section_1">Introduction</a> earlier, ACS Bluetooth middleware utilizes Bluetooth Session manager to identify application instances. So, to start utilizing ACS Bluetooth APIs, each application client needs to open a Bluetooth session as follows:</p>
<ul>
<li>BLE only mode</li>
<li>Dual mode (Classic+BLE)</li>
</ul>
<p>Classic only mode is currently not yet supported as most of the stacks are either LE only or dual-mode stacks.</p>
<h2><a class="anchor" id="autotoc_md65"></a>
Example 1 - Opening a Bluetooth session :</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ace/aceBT_session_api.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="structaceBT__session.html">aceBT_sessionHandle</a> btSessionHandle;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">void <a class="code" href="group__ACE__BT__SESSION__API__CB.html#ga06a014da5b892fb2b083502ce17b373e">acebt_session_state_callback</a>(<a class="code" href="structaceBT__session.html">aceBT_sessionHandle</a> sessionHandle, <a class="code" href="group__ACE__BT__DS__Session.html#ga3ef49c708122f3545b805b4651251119">aceBT_sessionState_t</a> state)</div><div class="line">{</div><div class="line">  ...</div><div class="line">   <span class="comment">// Handle session state changed events</span></div><div class="line">}</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">void bt_routine()</div><div class="line">{</div><div class="line">  <a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> status = <a class="code" href="group__ACE__BT__SESSION__API.html#ga3b10b894d58389500fc7ee1a60a57db7">aceBT_openSession</a>(<a class="code" href="group__ACE__BT__DS__Session.html#gga4fdfac183be0838af274b3df3fda9e9ba16edb3e9b94730aa87863e57bdba0fad">ACEBT_SESSION_TYPE_DUAL_MODE</a>, &amp;<a class="code" href="group__ACE__BT__SESSION__API__CB.html#ga06a014da5b892fb2b083502ce17b373e">acebt_session_state_callback</a>, *btSessionHandle);</div><div class="line">  <span class="keywordflow">if</span> (status == <a class="code" href="group__ACE__BT__DS__COMMON.html#gga7008967479aba75c4dd4b6dbde34a6e9af97ce0f100ff9e08640dfaed345f57e1">ACEBT_STATUS_SUCCESS</a>)</div><div class="line">  {</div><div class="line">      ...</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_cleanup()</div><div class="line">{</div><div class="line">  ...</div><div class="line">  <a class="code" href="group__ACE__BT__SESSION__API.html#ga00be08b2bdfb3697ae5dd114de44fd55">aceBT_closeSession</a>(btSessionHandle); <span class="comment">// This will auto-cleanup the references to all the registered callbacks for this client</span></div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md66"></a>
Example 2 - Register Classic callbacks :</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;aceBT_api.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// BT callback definitions</span></div><div class="line"><span class="keywordtype">void</span> bt_adapter_state_cb(<a class="code" href="group__ACE__BT__DS__COMMON.html#ga0499f34c0745f810d0140bca7591d01e">aceBT_state_t</a> state);</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_adapter_discovery_state_cb(<a class="code" href="group__ACE__BT__DS__COMMON.html#gaec3b5864037706edfe6063c458ffdda4">aceBT_discoveryState_t</a> state)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_bond_state_cb(<a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> status, <a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line">                                    <a class="code" href="group__ACE__BT__DS__COMMON.html#ga0516c3a0469d4b848c43f747f84fa56c">aceBT_bondState_t</a> state)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_conn_state_cb(<a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> status, <a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line">                                    <a class="code" href="group__ACE__BT__DS__COMMON.html#gacea021d4e42c4c733fef82108ab05ec1">aceBT_connState_t</a> state)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_profile_state_cb(<a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> status, <a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line">                                       <a class="code" href="group__ACE__BT__DS__COMMON.html#ga7a76d5097e226c49289928e8a7019acd">aceBT_profile_t</a> profile, <a class="code" href="group__ACE__BT__DS__COMMON.html#gacea021d4e42c4c733fef82108ab05ec1">aceBT_connState_t</a> state)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_device_discovered_cb(<a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr, <span class="keywordtype">int</span> propCount,</div><div class="line">                                           <a class="code" href="structaceBT__property__t.html">aceBT_property_t</a> *p_properties)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_bond_pin_request_cb(<a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line">                                           <a class="code" href="structaceBT__bdName__t.html">aceBT_bdName_t</a> *p_remote_name, <span class="keywordtype">int</span> cod,</div><div class="line">                                           <span class="keywordtype">bool</span> isMin16DigitPin)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_bond_ssp_request_cb(<a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line">                                           <a class="code" href="structaceBT__bdName__t.html">aceBT_bdName_t</a> *p_remote_name, <span class="keywordtype">int</span> cod,</div><div class="line">                                           <a class="code" href="group__ACE__BT__DS__COMMON.html#ga1dbf3214230f9ca78410ccb7f252312e">aceBT_sspVariant_t</a> ssp_type, uint32_t pass_key)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div><div class="line"><span class="comment">// End of BT callbacks definition</span></div><div class="line"></div><div class="line">    <span class="keyword">static</span> <a class="code" href="structaceBT__callbacks__t.html">aceBT_callbacks_t</a> bt_callbacks_selective = {</div><div class="line">        <span class="keyword">sizeof</span> (<a class="code" href="structaceBT__callbacks__t.html">aceBT_callbacks_t</a>),</div><div class="line">        bt_adapter_state_cb,</div><div class="line">        bt_adapter_discovery_state_cb,</div><div class="line">        NULL,</div><div class="line">        NULL,</div><div class="line">        NULL,</div><div class="line">        NULL</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <a class="code" href="structaceBT__callbacks__t.html">aceBT_callbacks_t</a> bt_callbacks_all = {</div><div class="line">        <span class="keyword">sizeof</span> (<a class="code" href="structaceBT__callbacks__t.html">aceBT_callbacks_t</a>),</div><div class="line">        bt_adapter_state_cb,</div><div class="line">        bt_adapter_discovery_state_cb,</div><div class="line">        bt_bond_state_cb,</div><div class="line">        bt_conn_state_cb,</div><div class="line">        bt_profile_state_cb,</div><div class="line">        bt_device_discovered_cb</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">static</span> aceBT_security_callbacks_t bt_security_callbacks = {</div><div class="line">        <span class="keyword">sizeof</span> (<a class="code" href="structaceBT__callbacks__t.html">aceBT_callbacks_t</a>),</div><div class="line">        bt_bond_pin_request_cb,</div><div class="line">        bt_bond_ssp_request_cb</div><div class="line">    };</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_routine()</div><div class="line">{</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Client does not want any callbacks</span></div><div class="line">    <span class="comment">// Do nothing</span></div><div class="line"></div><div class="line">    <span class="comment">// Client wants to register callbacks selectively</span></div><div class="line">    <a class="code" href="group__ACE__BT__API__CLASSIC.html#gafe5ae1e6ea6e3845d5d6fbbfd1d87593">aceBT_registerClientCallbacks</a>(btSessionHandler, &amp; bt_callbacks_selective);</div><div class="line"></div><div class="line">    <span class="comment">// OR Client wants to register all callbacks</span></div><div class="line">    <span class="comment">//aceBT_registerClientCallbacks(btSessionHandle, &amp; bt_callbacks_all);</span></div><div class="line"></div><div class="line">    <span class="comment">// Client wants to register for bonding callbacks</span></div><div class="line">    <a class="code" href="group__ACE__BT__API__COMMON.html#ga3ca67ff1e9891811e08695f5463c11f7">aceBT_registerAsSecurityClient</a>(btSessionHandle, &amp;bt_security_callbacks);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md67"></a>
Example 2 - Enable Radio :</h2>
<div class="fragment"><div class="line">...</div><div class="line">void bt_routine()</div><div class="line">{</div><div class="line">    <a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> bt_status;</div><div class="line">    ...</div><div class="line">    <span class="comment">// Enable BT Radio</span></div><div class="line">    bt_status = <a class="code" href="group__ACE__BT__API__COMMON.html#gaeeed22e2ab7b1be63151a82565669117">aceBT_enableRadio</a>(btSessionHandle);</div><div class="line">    ...</div><div class="line">    <span class="comment">// Disable BT Radio</span></div><div class="line">    bt_status = <a class="code" href="group__ACE__BT__API__COMMON.html#ga7c15ec3252936e6fa96cecaecceb9d8c">aceBT_disableRadio</a>(btSessionHandle);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md68"></a>
Example 3 - Pair to Classic Bluetooth device :</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> bt_device_discovered_cb(<a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr, <span class="keywordtype">int</span> propCount, <a class="code" href="structaceBT__property__t.html">aceBT_property_t</a> *p_properties)</div><div class="line">{</div><div class="line">  <span class="comment">// Found the needed device. Do a context switch to client thread context and invoke bt_routine_2()</span></div><div class="line">}</div><div class="line">...</div><div class="line"> <span class="keywordtype">void</span> bt_routine()</div><div class="line">{</div><div class="line">    <a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> bt_status;</div><div class="line">    ...</div><div class="line">    <span class="comment">// Start device discovery</span></div><div class="line">    bt_status = <a class="code" href="group__ACE__BT__API__CLASSIC.html#gaba4ccc638e7db6835f9c44bb7fd6a4b2">aceBT_startDeviceDiscovery</a>(btSessionHandle);</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_routine_2()</div><div class="line">{</div><div class="line">    <a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> bt_status;</div><div class="line">    ...</div><div class="line">    <span class="comment">//  Stop device discovery</span></div><div class="line">    bt_status = <a class="code" href="group__ACE__BT__API__CLASSIC.html#gac82674fa2be8d9c6573983ff6b4c02f9">aceBT_stopDeviceDiscovery</a>(btSessionHandle);</div><div class="line">    <span class="comment">// Use the aceBT_addr_t from discovered devices callback</span></div><div class="line">    bt_status = <a class="code" href="group__ACE__BT__API__COMMON.html#gadb6802e867c6a70ab5ecfcd9f7a9dcf9">aceBT_pair</a>(p_remoteAddr);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_bond_ssp_request_cb(<a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line">                                           <a class="code" href="structaceBT__bdName__t.html">aceBT_bdName_t</a> *p_remote_name, <span class="keywordtype">int</span> cod,</div><div class="line">                                           <a class="code" href="group__ACE__BT__DS__COMMON.html#ga1dbf3214230f9ca78410ccb7f252312e">aceBT_sspVariant_t</a> ssp_type, uint32_t pass_key)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="comment">// Do a context switch to client thread context and invoke bt_ssp_reply() in client code</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> bt_ssp_reply(<a class="code" href="structaceBT__bdAddr__t.html">aceBT_bdAddr_t</a> *p_remote_addr,</div><div class="line"></div><div class="line">                                           <a class="code" href="structaceBT__bdName__t.html">aceBT_bdName_t</a> *p_remote_name, <span class="keywordtype">int</span> cod,</div><div class="line">                                           <a class="code" href="group__ACE__BT__DS__COMMON.html#ga1dbf3214230f9ca78410ccb7f252312e">aceBT_sspVariant_t</a> ssp_type, uint32_t pass_key)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group__ACE__BT__API__COMMON.html#ga1abf4c492541dc6c038fe891ebff2d2e">aceBT_acceptPairingConfirmation</a>(p_remote_name, TRUE); <span class="comment">// Accept incoming SSP</span></div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md69"></a>
Example 4 - Create GATT Server - Beacon :</h2>
<div class="fragment"><div class="line"><span class="comment">// BLE callbacks</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="structaceBT__bleCallbacks__t.html">aceBT_bleCallbacks_t</a>  ble_client_callback =  {</div><div class="line">    <span class="keyword">sizeof</span>(<a class="code" href="structaceBT__bleCallbacks__t.html">aceBT_bleCallbacks_t</a>),</div><div class="line">    {</div><div class="line">        <span class="keyword">sizeof</span>(<a class="code" href="structaceBT__commonCallbacks__t.html">aceBT_commonCallbacks_t</a>),</div><div class="line">        adapter_state_cbk,</div><div class="line">        NULL,</div><div class="line">    },</div><div class="line">    on_ble_reg_cbk,</div><div class="line">    ble_connection_state_changed_cbk,</div><div class="line">    ble_mtu_updated_cbk,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// Beacon callbacks</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="structaceBT__beaconCallbacks__t.html">aceBT_beaconCallbacks_t</a> beacon_callbacks = {</div><div class="line">    <span class="keyword">sizeof</span>(<a class="code" href="structaceBT__beaconCallbacks__t.html">aceBT_beaconCallbacks_t</a>),</div><div class="line">    adv_state_changed,</div><div class="line">    scan_state_changed,</div><div class="line">    scan_results,</div><div class="line">    on_beacon_client_registered</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="structaceBT__session.html">aceBT_sessionHandle</a> bt_session;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> ble_routine()</div><div class="line">{</div><div class="line">    <a class="code" href="group__ACE__BT__DS__COMMON.html#ga7008967479aba75c4dd4b6dbde34a6e9">aceBT_status_t</a> status = <a class="code" href="group__ACE__BT__SESSION__API.html#ga3b10b894d58389500fc7ee1a60a57db7">aceBT_openSession</a>(<a class="code" href="group__ACE__BT__DS__Session.html#gga4fdfac183be0838af274b3df3fda9e9ba71c87608595e5db952bd53c2384f5ff1">ACEBT_SESSION_TYPE_BLE</a>, NULL, &amp;bt_session);</div><div class="line">    <span class="comment">// Register BLE</span></div><div class="line">    <a class="code" href="group__ACE__BLE__API__COMMON.html#ga825112d270ec78b2990c7cf097d6a1b4">aceBT_bleRegister</a>(bt_session, &amp;ble_client_callback);</div><div class="line">    ble_init_beacon();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> ble_init_beacon()</div><div class="line">{</div><div class="line">    <a class="code" href="structaceBT__AdvInstance.html">aceBT_advInstanceHandle</a> advInstanceHandle;</div><div class="line">    <span class="comment">// Register this app as a Beacon Client</span></div><div class="line">    <a class="code" href="group__ACE__BLE__API__BEACON.html#ga70338ffd332fde1649940b933a0f06cd">aceBT_RegisterBeaconClient</a>(bt_session, &amp;beacon_callbacks);</div><div class="line">    <a class="code" href="structaceBT__BeaconAdvSettings.html">aceBT_BeaconAdvSettings</a> advSettings;</div><div class="line">    <a class="code" href="structaceBT__BeaconPayloadList__t.html">aceBT_BeaconPayloadList_t</a> payload;</div><div class="line">    <a class="code" href="structaceBT__BeaconPayloadList__t.html">aceBT_BeaconPayloadList_t</a> scan_respPayload;</div><div class="line">    aceBT_BeaconClientId clientId = 0xFF; <span class="comment">// No specific client ID needs to be defined.</span></div><div class="line"></div><div class="line">    advSettings.<a class="code" href="structaceBT__BeaconAdvSettings.html#a472fecf95beb35f495a6848f87144619">connectable</a> = <span class="keyword">false</span>;</div><div class="line">    advSettings.<a class="code" href="structaceBT__BeaconAdvSettings.html#a2fdd8646a719786214ea6420261bc33f">enablePrivacy</a> = <span class="keyword">false</span>;</div><div class="line">    advSettings.<a class="code" href="structaceBT__BeaconAdvSettings.html#a748003f896d5f0512674864e5f0fadbf">timeout</a> = 120;</div><div class="line">    advSettings.<a class="code" href="structaceBT__BeaconAdvSettings.html#a0a63cab1b1252d1aa1790e24e1ddc8bf">mode</a> = <a class="code" href="group__ACE__BLE__DS__BEACON.html#ggaa414a9d76fd55c267b15b33b813079ffa8c676c8bcb260ef0e128071667e22181">ACEBT_BEACON_MODE_LOW_LATENCY</a>;</div><div class="line"></div><div class="line">    <span class="comment">// Define Beacon data</span></div><div class="line">    payload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a> = (<a class="code" href="structaceBT__BeaconData__t.html">aceBT_BeaconData_t</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structaceBT__BeaconData__t.html">aceBT_BeaconData_t</a>));</div><div class="line">    payload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a091af4f761a40dab205775a1770a4712">numberOfBeacons</a> = 1;</div><div class="line">    <a class="code" href="structaceBT__BeaconData__t.html">aceBT_BeaconData_t</a> *data = &amp;payload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a>[0];</div><div class="line">    payload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a>[0].<a class="code" href="structaceBT__BeaconData__t.html#ae119da5fd2ce592b7170a77e29a9b242">includeTxPower</a> = <span class="keyword">false</span>;</div><div class="line">    payload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a>[0].<a class="code" href="structaceBT__BeaconData__t.html#aa7c8f2dc3a6d3bc182b611103820a25a">includeDeviceName</a> = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Define Scan response payload</span></div><div class="line">    scan_respPayload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a> = (<a class="code" href="structaceBT__BeaconData__t.html">aceBT_BeaconData_t</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structaceBT__BeaconData__t.html">aceBT_BeaconData_t</a>));</div><div class="line">    scan_respPayload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a091af4f761a40dab205775a1770a4712">numberOfBeacons</a> = 1;</div><div class="line">    <a class="code" href="structaceBT__BeaconData__t.html">aceBT_BeaconData_t</a> *data_scan = &amp;scan_respPayload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a>[0];</div><div class="line">    scan_respPayload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a>[0].<a class="code" href="structaceBT__BeaconData__t.html#ae119da5fd2ce592b7170a77e29a9b242">includeTxPower</a> = <span class="keyword">false</span>;</div><div class="line">    scan_respPayload.<a class="code" href="structaceBT__BeaconPayloadList__t.html#a2d31d5c6ac97eb78f3bd59cd05822c25">beaconArray</a>[0].<a class="code" href="structaceBT__BeaconData__t.html#aa7c8f2dc3a6d3bc182b611103820a25a">includeDeviceName</a> = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Init Beacon data</span></div><div class="line">    <a class="code" href="group__ACE__BLE__API__BEACON.html#ga25bc9eb8f8fd93d83e3d0101ae82da29">aceBT_initBeaconData</a>(data);</div><div class="line">    <a class="code" href="group__ACE__BLE__API__BEACON.html#ga37234b17be06ce4838b55c021a6cac69">aceBT_appendManufactureId</a>(data, 0x1234, (uint8_t*)<span class="stringliteral">&quot;Test ACS Beacon&quot;</span>,16);</div><div class="line">    <a class="code" href="structaceBT__uuid__t.html">aceBT_uuid_t</a> uuid = {</div><div class="line">                   .<a class="code" href="structaceBT__uuid__t.html#a177c5bda8dd8fa9c19f531515e5ae6b1">type</a>=<a class="code" href="group__ACE__BT__DS__COMMON.html#ggabc367f9d05eb66f87001cbb382e408e4ada107c59034aa76a3893418663c28003">ACEBT_UUID_TYPE_128</a>,</div><div class="line">                   .uu={0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,</div><div class="line">                        0x09, 0x0A, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F}};</div><div class="line"></div><div class="line">    <a class="code" href="group__ACE__BLE__API__BEACON.html#ga754768a06e2bdfbc5df2cf9c02d57f2e">aceBT_appendServiceData</a>(data,uuid,(uint8_t*)<span class="stringliteral">&quot;111111&quot;</span>,6);</div><div class="line">    data-&gt;<a class="code" href="structaceBT__BeaconData__t.html#a519114fb90281c63831335c086d988f9">beaconType</a> = <a class="code" href="group__ACE__BLE__DS__BEACON.html#gga722f51c9e6cd461b796b781a1dbb9e31a8cb84552b81dcf5ee5340f358cf0cf52">ACEBT_BEACON_TYPE_PASSTHROUGH</a>;</div><div class="line">    <a class="code" href="group__ACE__BLE__API__BEACON.html#ga8371863f596067a0791f503648670181">aceBT_startBeaconWithScanResponse</a>(bt_session,advSettings,</div><div class="line">        clientId, payload, scan_respPayload, &amp;advInstanceHandle);</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="bt_section_5"></a>
Build Artifacts</h1>
<p>If Bluetooth middleware is build in "lite" configuration -</p><ul>
<li>Shared library name: libace_bt</li>
<li>Includes API and middleware as a single shared library</li>
</ul>
<p>If Bluetooth middleware is built in regular configuration -</p><ul>
<li>Shared library name for API calls : libace_bt</li>
<li>Executable Service for middleware : btmanagerd</li>
</ul>
<p>Optional test CLI shared library : libace_bt_cli</p><ul>
<li>This shared library will be used by ACS CLI framework to exercise BT CLI options</li>
</ul>
<h1><a class="anchor" id="bt_section_6"></a>
FAQ</h1>
<p>Q. How will ACS Bluetooth middleware integrate with a platform? A. The platforms need to implement a Bluetooth HAL on top of the existing platform's stack or SDK. ACS Bluetooth middleware can be configured to run for a single app mode (using "lite" configuration) as a shared lib for BT APIs or multi-app mode (regular configuration with ACS AIPC) as a shared lib for BT APIs and a daemon for BT middleware. These artifacts will interact with ACS Bluetooth HAL's well defined interface to exercise Bluetooth functionalities.</p>
<p>Q. How will ACS Bluetooth middleware work if the platform already has an existing middleware? A. There are a couple of proposals in this case :<br />
</p><ul>
<li>Replace the existing middleware ACS Bluetooth middleware which will bring in multi-client support;</li>
<li>Abstract the existing middleware calls as ACS Bluetooth HAL Running both middleware concurrently can lead to corruption of various handles in both the underlying stack/controller.</li>
</ul>
<p>Q. How does one debug issues arising from the ACS Bluetooth middleware? A. ACS Bluetooth middleware uses OSAL Logging module to print debug/info/error logs. Use the platform's logs to debug the middleware logging. Another recommendation would be to use the underlying stack/SDK's BT snoop logs along with the middleware logs to debug issues.</p>
<p>Q. What is the thread context of the callbacks invoked by ACS Bluetooth middleware? A. For platforms configured to use IPC, all client callbacks are dispatched from IPC's internal thread. For 'lite' configurations, the client callbacks are dispatched from the underlying stack/SDK thread. Hence it is recommended to do a context switch in the client app while handling callbacks. This will help prevent the underlying stack in waiting for long time and in case of IPC avoid nested calls between IPC client/server.</p>
<h1><a class="anchor" id="bt_section_7"></a>
References</h1>
<ul>
<li><a class="el" href="group__ACEBT.html">ACE Bluetooth Middleware</a> </li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
