<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACS: ESP32 Quick Start Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ACS
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)"
               onblur="searchBox.OnSearchFieldFocus(false)"
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__ESP32__QUICK__START__GUIDE.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0"
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ESP32 Quick Start Guide<div class="ingroups"><a class="el" href="group__ACS__CORE__DOCS.html">ACS Core Docs</a> &raquo; <a class="el" href="group__QUICK__START__GUIDE.html">Quick Start Guides</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for ESP32 Quick Start Guide:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__ESP32__QUICK__START__GUIDE.png" border="0" alt="" usemap="#group____ESP32____QUICK____START____GUIDE"/>
<map name="group____ESP32____QUICK____START____GUIDE" id="group____ESP32____QUICK____START____GUIDE">
<area shape="rect" id="node2" href="group__QUICK__START__GUIDE.html" title="Quick Start Guides" alt="" coords="5,5,139,32"/>
</map>
</td></tr></table></center>
</div>
<ul>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section1">Introduction</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section2">Getting Started</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section3">Step 1: Set up ESP Development Environment (Linux)</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section4">Step 2: Download ACS</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section5">Step 3: Build/Flash the Distributed Binaries</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section6">Step 4: Provision your device for FFS</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section7">Step 5: Use FFS test app to configure your device as Smartlight</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section8">Step 6: Use Alexa app to turn on/off the LED in your Wrover</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section9">FAQs / Troubleshooting</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section10">Support</a></li>
<li><a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section11">Appendix : Provisioning Script</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="esp_section1"></a>
Introduction</h1>
<p>This is a step-by-step guide to evaluate Amazon Common Software (ACS) for Connected Devices using the Wrover development kit from Espressif. Users of this guide will be able to experience the kit as a SmartLight device. Once provisioned, an Alexa companion app can be used to turn on and off an LED in the Wrover.</p>
<hr/>
 <h1><a class="anchor" id="esp_section2"></a>
Getting Started</h1>
<p><b>Required hardware and software</b></p>
<ul>
<li>Espressif Wrover kit can be purchased directly from Amazon <a href="https://www.amazon.com/ESP32-WROVER-KIT-Board-Espressif-Colour-Display/dp/B07GLXRQWZ/ref=sr_1_2?keywords=wrover&amp;qid=1576096809&amp;sr=8-2">here</a>.</li>
<li>Micro-USB power cable</li>
<li>Internet connection over WiFi</li>
<li>Android app (link provided below)</li>
</ul>
<p>Set up the ESP32 Wrover Kit per instructions. The following image shows the features of the ESP32 Wrover Kit.</p>
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/3234958382._CB426634784_.png">
<hr/>
 <h1><a class="anchor" id="esp_section3"></a>
Step 1: Set up ESP Development Environment (Linux)</h1>
<p>Follow the link to set up the toolchain. Get ESP-IDF and install the required Python packages. Source code for ESP-IDF is not needed for evaluating ACS with Wrover kit. <a href="https://docs.espressif.com/projects/esp-idf/en/stable/get-started/linux-setup.html">https://docs.espressif.com/projects/esp-idf/en/stable/get-started/linux-setup.html</a></p>
<hr/>
 <h1><a class="anchor" id="esp_section4"></a>
Step 2: Download ACS</h1>
<p>Download the ACS package for ESP32 Wrover from Amazon here:</p>
<p><a href="https://developer.amazon.com/acs-devices/console/download/ESP32">[-DOWNLOAD-]</a></p>
<hr/>
 <h1><a class="anchor" id="esp_section5"></a>
Step 3: Build/Flash the Distributed Binaries</h1>
<p>There are two ways you can install ACS on your Wrover:</p>
<ol type="1">
<li>Copy the binaries distributed with the release, or</li>
<li>Build the code from source on an Ubuntu computer and install the result on Wrover.</li>
</ol>
<p><b>Building and flashing the binaries</b></p>
<p>Open a terminal and follow these steps:</p>
<div class="fragment"><div class="line">cd &lt;path of package&gt;</div><div class="line">cd vendors/espressif/esp32/projects/smartlight/apps/smarthome</div><div class="line">rm -rf build</div><div class="line">make -j8</div><div class="line">export ESPPORT=/dev/ttyUSB1</div><div class="line">(Note: The serial port on your machine can be different. Obtain the port using &#39;dmesg&#39;)</div><div class="line"></div><div class="line">make flash</div></div><!-- fragment --><p><b>Flashing the binaries from the ACS package</b></p>
<p>Open a terminal and follow these steps:</p>
<div class="fragment"><div class="line">cd &lt;path of package&gt;</div><div class="line">cd vendors/espressif/esp32/dpk/vendors/espressif/esp-idf/components/esptool_py/esptool</div><div class="line">python esptool.py --chip esp32 --port PORT --baud 921600 --before default_reset --after hard_reset write_flash -z --flash_mode dio --flash_freq 40m --flash_size detect 0x16000 /PATH/TO/ota_data_initial.bin 0x1000 /PATH/TO/bootloader.bin 0x20000 /PATH/TO/aws_tests.bin 0x8000 /PATH/TO/partition-table.bin</div></div><!-- fragment --><p>Note: If the flashing tool is stuck in the "Connecting........_____" stage, press the reset (marked <b>EN</b>) button on the Wrover (button nearest to the micro USB port) to continue flashing.</p>
<hr/>
 <h1><a class="anchor" id="esp_section6"></a>
Step 4: Provision your device for FFS</h1>
<p>Navigate to the ACS portal registration website at this link: <a href="https://developer.amazon.com/acs-devices/console">https://developer.amazon.com/acs-devices/console</a></p>
<p>Using this page, you will be able to get the data values you need to register your device. Once you have logged in, navigate to the <a href="https://developer.amazon.com/acs-devices/console/manage">Manage Device Certificates</a> page.</p>
<p>Click on the <b>Request New DSN</b> button to pop open the device type submenu, and then click on the <b>ESP32</b> option. You should now see a new row that contains the name of your product (ESP32 Dev Kit), a Device Serial Number, and an orange button labeled <b>Get New Certificate</b>. Click on the <b>Get New Certificate</b> button, and you should see a <b>Get New Certificate</b> pop-up that contains three steps. Click on the <b>Download</b> button underneath the first step to receive a JSON file containing the DSN, DT, RPI_PUB_KEY, and CLIENT_ID. Move this JSON file to where your provisioning script, <code>provision.py</code>, is located (see <a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section11">Appendix : Provisioning Script</a>).</p>
<p>Note: Python OpenSSL library (pyOpenSSL) is needed for this script.</p>
<div class="fragment"><div class="line">sudo python -m easy_install --upgrade pyOpenSSL</div></div><!-- fragment --><p>Now, run the provisioning script <code>provision.py</code>. This script takes three arguments: a COM port (example-/dev/ttyUSB0), a command to execute, and (in some cases) a file name.</p>
<p>Run this script with the COM port of your ESP32, the command <code>provision</code>, and the name of the JSON file that you previously downloaded from the portal.</p>
<div class="fragment"><div class="line">provision.py -p &lt;COM-port&gt; -c provision -x &lt;JSON-filename&gt;</div></div><!-- fragment --><p>Next, run the script with the COM port of your ESP32 and the command <code>get_csr</code>. This step will generate a Certificate Signing Request, and create a file called <code>csr.pem</code> where the script is located.</p>
<div class="fragment"><div class="line">provision.py -p &lt;COM-port&gt; -c get_csr </div></div><!-- fragment --><p>Copy the text from this file and paste it into the text field under step 3 of the <b>Get New Certificate</b> pop-up on the ACS portal website, and click submit. After a couple of seconds, the orange <b>Get New Certificate</b> button should change to a green <b>Download Certificate</b> button; click on this button to download your signed certificate. Move this signed certificate to where your provisioning script is located.</p>
<p>Run the provision script one last time with the COM port of your ESP32, the command <code>save_cert</code>, and the name of the signed certificate that you downloaded earlier.</p>
<div class="fragment"><div class="line">provision.py &lt;COM-port&gt; -c save_cert -f &lt;Certificate-filename&gt;</div></div><!-- fragment --><p>The program will now validate your signed certificate, and if the certificate is valid, then the program will output <b>Device Registered</b> and will gracefully terminate. You are now ready to move on to the next step.</p>
<p>Congrats! Your Wrover is now provisioned to start Frustration Free Setup.</p>
<hr/>
 <h1><a class="anchor" id="esp_section7"></a>
Step 5: Use FFS test app to configure your device as Smartlight</h1>
<p>FFS technology simplifies the setup of connected devices by utilizing a peer-assisted model for setup, whereby a device which is connected to the Internet (Provisioner) aids a new device (Provisionee) to get connected to the Internet. FFS not only helps the devices to connect to the Internet but also in many cases makes it ready for use. This includes registering the device to a customer's Amazon account, configuring the device based on account preferences, and connecting it with the Alexa Ecosystem. In this case, when we run the sample app (downloaded in <a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section4">Step 2: Download ACS</a>) your ESP32 will be the Provisionee, and your mobile phone with the Amazon test app will be the Provisioner.</p>
<p>If you haven't already, connect your phone to a WiFi or cellular data network and make sure that Bluetooth functionality is turned on. Next, download the mobile provisioning app for your mobile phone. You will have to install and use a specific test app, which can downloaded at this link for Android.</p>
<p><a href="https://developer.amazon.com/acs-devices/console/download/FFSAndroidApp">[-DOWNLOAD-]</a></p>
<p>Now, run the FFS app on the ESP32 device. This app will run through the FFS flow, which involves the following steps.</p>
<ul>
<li>First, the ESP32 will begin to advertise a Bluetooth Low Energy (BLE) connection. The FFS test app on your mobile device should find this BLE advertisement, and initiate a connection.</li>
<li>Once the connection between the ESP32 and the mobile device has been established, the ESP32 scans the area for available Wifi networks, and communicates this information back to the mobile device. Using your mobile device, you will select one of these Wifi networks and enter the password, which will then be communicated back to the ESP32 using the Bluetooth connection.</li>
<li>The FFS app on the ESP32 will then connect to the Wifi network with the provided credentials, interact with Amazon servers, and receive access tokens that allow for communication with Smarthome endpoints. While there are many components to this flow, the ESP32 side of the flow is automatically taken care of by the FFS app. Your interactions with this flow, limited to the FFS mobile app, involve initiating the BLE connection, selecting a WIFI network, and entering a password.</li>
</ul>
<p><b>Setup Instructions</b></p>
<p>On the device side, reset the device by clicking the <b>EN</b> button which is near the USB port on the device. Open the device's serial port. A serial port terminal such as <a href="http://cutecom.sourceforge.net/">CuteCom</a> or <a href="https://help.ubuntu.com/community/Minicom">miniCom</a> is required to interact with device.</p>
<p>Issue the following command on the device CLI using the serial port terminal:</p>
<div class="fragment"><div class="line">--&gt; ace mw wifi get_config</div></div><!-- fragment --><p>This will return the existing AP configured in WiFi settings.</p>
<div class="fragment"><div class="line">--&gt; ace mw wifi remove_network &lt;AP returned from the previous command&gt;</div><div class="line">--&gt; ace mw wifi save_config</div><div class="line">--&gt; ace mw ffs init</div><div class="line">--&gt; ace mw ffs start 7</div></div><!-- fragment --><p>Install the Android app using the Google adb tool:</p>
<div class="fragment"><div class="line">adb install &lt;FFS test app&gt;</div></div><!-- fragment --><p>Note: adb drivers may be used to install it over USB.</p>
<p>For account whitelisting, e-mail <a href="#" onclick="location.href='mai'+'lto:'+'ace'+'-s'+'mar'+'th'+'ome'+'ev'+'al@'+'am'+'azo'+'n.'+'com'; return false;">ace-smarthomeeval@amazon.com</a> with your amazon.com user ID that was created in the US account (only US accounts are supported at this time), and wait for confirmation that your account has been whitelisted. This will trigger an e-mail inviting you to test the new Alexa skill. Follow the instructions in the e-mail to complete whitelisting.</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/esp32_qkstart-3._CB1578005343_.png" width="80%"/>
</div>
<p>Log in to the FFS test app and Alexa app using the whitelisted account credentials.</p>
<p>Launch FFS test app. Select 'UI based setup activity' on the main menu.</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/esp32_qkstart-4._CB1578005342_.png" width="80%"/>
</div>
<p>Select the BT name used when provisioning the device. BT name in this example is knatham-rover_1. The FFS test app will connect to the Wrover over BT.</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/esp32_qkstart-5._CB1578005342_.png" width="80%"/>
</div>
<p>Select the WiFi network that needs to be provisioned in the Wrover. Wrover will connect to this WiFi to complete the setup. The WiFi selected in this example is "Guest".</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/esp32_qkstart-6._CB1578005342_.png" width="80%"/>
</div>
<p>Now the light should have been added on Alexa app. Uninstall FFS Test app and install Amazon Alexa app.</p>
<p>At this time, your Alexa app should receive a notification with the device name that is connected to your App.</p>
<p>If the FFS registration fails in between, deregister the device as described in <a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section9">FAQs / Troubleshooting</a>.</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/esp32_qkstart-7._CB1578005681_.png" width="35%"/>
</div>
<p>Press the <b>Reset</b> button on the Wrover at this time. You are now ready to control the Wrover LED using your Alexa app from the Android/iOS App Store.</p>
<hr/>
 <h1><a class="anchor" id="esp_section8"></a>
Step 6: Use Alexa app to turn on/off the LED in your Wrover</h1>
<p>Select the device name, "Fortieth light" in this example, that the Wrover represents. Now you can turn on and off the LED in the Wrover using the Alexa app.</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/esp32_qkstart-8._CB1578005342_.png" width="80%"/>
</div>
<hr/>
 <h1><a class="anchor" id="esp_section9"></a>
FAQs / Troubleshooting</h1>
<ul>
<li><p class="startli"><b>Q</b>: During the ESP-IDF setup process, I'm running into this error: Failed to open port /dev/ttyUSB0</p>
<p class="startli">A: Follow the instructions here to add current user to dialout group: <a href="https://docs.espressif.com/projects/esp-idf/en/stable/get-started/establish-serial-connection.html#linux-dialout-group">https://docs.espressif.com/projects/esp-idf/en/stable/get-started/establish-serial-connection.html#linux-dialout-group</a></p>
</li>
<li><p class="startli"><b>Q</b>: FFS app is crashing on Android.</p>
<p class="startli">A: Try the older app version given <a href="https://w.amazon.com/bin/view/DevicePlatform/DeviceProvisioningSDK/FrustrationFreeSetup/WhereCanIFindABuildOf">here</a>.</p>
</li>
<li><p class="startli"><b>Q</b>: Wrover is not showing in FFS app.</p>
<p class="startli">A: Try to exit the FFS app and launch it again.</p>
</li>
<li><p class="startli"><b>Q</b>: After provisioning and resetting my Wrover, I see this error in my Wrover terminal: MQTT error: -24</p>
<p class="startli">A: Check WiFi using: <code>ace mw wifi ping 8.8.8.8</code></p>
</li>
<li><p class="startli"><b>Q</b>: After provisioning and resetting my Wrover, I see this error in my Wrover terminal: MQTT error: -12</p>
<p class="startli">A: Try to reregister (deregister and register) the device.</p>
</li>
<li><p class="startli"><b>Q</b>: How can I deregister the device?</p>
<p class="startli">A: Use this command: <code>ace mw maplite -d 5</code></p>
<p class="startli">Then remove WiFi credentials:</p>
<p class="startli"><code>ace mw wifi remove_network &lt;AP_NAME&gt;</code></p>
<p class="startli"><code>ace mw wifi save_config</code></p>
<p class="startli">Reboot then verify using: <code>ace mw wifi get_config</code></p>
</li>
<li><p class="startli"><b>Q</b>: While giving FFS start command, I see this error: <code>&lt;(aceffs)aceFfs_start&gt; not init</code></p>
<p class="startli">A: Try to deregister, reboot and that doesn't work, issue <code>ace mw ffs init</code> command and then start command.</p>
</li>
<li><p class="startli"><b>Q</b>: During provisioning of device certificate "DSN.pem" I see this error: r&lt;class 'multiprocessing.TimeoutError'&gt;</p>
<p class="startli">A: Close the connection to device from cutecom or minicom and try again.</p>
</li>
<li><p class="startli"><b>Q</b>: What part of DSS public key has to be set on to the device, I get <code>-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE2/JfOLzNOqKFpl52cvpG3o7quOHR\nEGcWRfqS8CYeKv7yYbS8+vcN7MlSgvdq6omZkh/3f768hMLpkZUAPREIrg==\n-----END PUBLIC</code> in device.info file.</p>
<p class="startli">A: You just need to take the portion between <code>\n &lt;actual key&gt;\n</code> in above: <code>MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE2/JfOLzNOqKFpl52cvpG3o7quOHR\nEGcWRfqS8CYeKv7yYbS8+vcN7MlSgvdq6omZkh/3f768hMLpkZUAPREIrg==</code>.</p>
</li>
<li><p class="startli"><b>Q</b>: Why is my FFS registration not going through?</p>
<p class="startli">A: Try the following related to your account:</p><ul>
<li>You are using US marketplace based whitelisted beta account.</li>
<li>You have added and enabled the smart home skill under dev section of Alexa app.</li>
</ul>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="esp_section10"></a>
Support</h1>
<p>Please refer all feedback and support-related questions to: <a href="#" onclick="location.href='mai'+'lto:'+'acs'+'-p'+'rev'+'ie'+'w-s'+'up'+'por'+'t@'+'ama'+'zo'+'n.c'+'om'; return false;">acs-p<span style="display: none;">.nosp@m.</span>revi<span style="display: none;">.nosp@m.</span>ew-su<span style="display: none;">.nosp@m.</span>ppor<span style="display: none;">.nosp@m.</span>t@ama<span style="display: none;">.nosp@m.</span>zon.<span style="display: none;">.nosp@m.</span>com</a></p>
<hr/>
 <h1><a class="anchor" id="esp_section11"></a>
Appendix : Provisioning Script</h1>
<p>Copy script below and name it <code>provision.py</code></p>
<div class="fragment"><div class="line">#!/usr/bin/python</div><div class="line">#</div><div class="line"># Copyright 2019 Amazon.com, Inc. or its affiliates. All rights reserved.</div><div class="line">#</div><div class="line"># AMAZON PROPRIETARY/CONFIDENTIAL</div><div class="line">#</div><div class="line"># You may not use this file except in compliance with the terms and conditions</div><div class="line"># set forth in the accompanying LICENSE.TXT file. This file is a</div><div class="line"># Modifiable File, as defined in the accompanying LICENSE.TXT file.</div><div class="line">#</div><div class="line"># THESE MATERIALS ARE PROVIDED ON AN &quot;AS IS&quot; BASIS. AMAZON SPECIFICALLY</div><div class="line"># DISCLAIMS, WITH RESPECT TO THESE MATERIALS, ALL WARRANTIES, EXPRESS,</div><div class="line"># IMPLIED, OR STATUTORY, INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY,</div><div class="line"># FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT.</div><div class="line">#</div><div class="line"></div><div class="line">from __future__ import print_function</div><div class="line">import argparse</div><div class="line">import random</div><div class="line">import serial</div><div class="line">import time</div><div class="line">import re</div><div class="line">import sys</div><div class="line">import json</div><div class="line">from datetime import datetime</div><div class="line">from multiprocessing.pool import ThreadPool</div><div class="line"></div><div class="line">############### CONSTANTS #####################################################</div><div class="line">INPUT_PORT = &#39;comport&#39;</div><div class="line">INPUT_COMMAND = &#39;command&#39;</div><div class="line">INPUT_DEVICE_INFO_CONFIG = &#39;device_info_config&#39;</div><div class="line">INPUT_SPEED = &#39;speed&#39;</div><div class="line">INPUT_DELAY_MS = &#39;delay_ms&#39;</div><div class="line">INPUT_CERT_FILE = &#39;cert_file&#39;</div><div class="line">INPUT_JSON_FILE = &#39;json_file&#39;</div><div class="line"></div><div class="line">def convert_ms_to_sec(ms):</div><div class="line">    return (ms/1000.0)</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">class device_cli():</div><div class="line"></div><div class="line">    def __init__(self, serial_port, delay_ms):</div><div class="line">        self.serial_port = serial_port</div><div class="line">        self.delay_sec = convert_ms_to_sec(delay_ms)</div><div class="line"></div><div class="line">    def set_device_info(self, device_serial, device_type, ffs_pid, dss_pub_key):</div><div class="line">        command = &#39;device_info set dsn &#39; + device_serial + &#39;\r\n&#39;</div><div class="line">        self.serial_port.write(command.encode())</div><div class="line">        self.__get_all_responses()</div><div class="line">        time.sleep(1)</div><div class="line"></div><div class="line">        command = &#39;device_info set type &#39; + device_type + &#39;\r\n&#39;</div><div class="line">        self.serial_port.write(command.encode())</div><div class="line">        self.__get_all_responses()</div><div class="line">        time.sleep(1)</div><div class="line"></div><div class="line">        command = &#39;device_info set ffs_pid &#39; + ffs_pid + &#39;\r\n&#39;</div><div class="line">        self.serial_port.write(command.encode())</div><div class="line">        self.__get_all_responses()</div><div class="line">        time.sleep(1)</div><div class="line"></div><div class="line">        pub_key_lines = dss_pub_key.splitlines()</div><div class="line">        command = &#39;device_info set dss_pub_key &#39; + &#39;\&quot;&#39;</div><div class="line">        for line in pub_key_lines:</div><div class="line">            if line.startswith(&#39;----&#39;):</div><div class="line">                continue;</div><div class="line">            else:</div><div class="line">                command += line</div><div class="line">        command += &#39;\&quot;&#39; + &#39;\r\n&#39;</div><div class="line">        self.serial_port.write(command.encode())</div><div class="line">        self.__get_all_responses()</div><div class="line">        time.sleep(2)</div><div class="line"></div><div class="line">    def set_cert_from_file(self, certFile):</div><div class="line">        cert_pem = get_from_file(certFile)</div><div class="line">        self.set_cert(cert_pem)</div><div class="line"></div><div class="line">    def write_to_serial(self, command, delay_sec):</div><div class="line">        if delay_sec == 0.0:</div><div class="line">            self.serial_port.write(command)</div><div class="line">        else:</div><div class="line">            # some devices can&#39;t be write to at normal speed and needs a delay</div><div class="line">            # for these insert a delay between chars</div><div class="line">            for c in command:</div><div class="line">                self.serial_port.write(c.encode())</div><div class="line">                time.sleep(delay_sec)</div><div class="line"></div><div class="line">    def set_cert(self, cert):</div><div class="line">        print(&#39;retval: 0 implies that provisioning material writing was successful. Please check provisioning material if retvalue is non-zero.&#39;)</div><div class="line">        cert_lines = cert.splitlines()</div><div class="line">        command = &#39;&#39;</div><div class="line">        for line in cert_lines:</div><div class="line">            command += line</div><div class="line">            command += &#39;\n&#39;</div><div class="line">        totalCommand = &#39;ace hal dha set_cert \&quot;&#39; + command + &#39;\&quot; \r\n&#39;</div><div class="line">        print(totalCommand)</div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line">        result = pool.apply_async(self.__get_res,())</div><div class="line"></div><div class="line">        self.write_to_serial(totalCommand, self.delay_sec)</div><div class="line"></div><div class="line">        result.get(timeout=10)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line"></div><div class="line">    def init_keygen(self):</div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line">        result = pool.apply_async(self.__init_keygen,())</div><div class="line">        command = &#39;ace hal dha key_gen\r\n&#39;</div><div class="line">        self.write_to_serial(command, self.delay_sec)</div><div class="line">        result.get(timeout=2)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line"></div><div class="line"></div><div class="line">    def get_csr(self):</div><div class="line">        self.init_keygen()</div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line">        result = pool.apply_async(self.__get_csr,())</div><div class="line">        command = &#39;ace hal dha get_field 0x201\r\n&#39;</div><div class="line">        self.write_to_serial(command, self.delay_sec)</div><div class="line"></div><div class="line">        csr = result.get(timeout=2)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line">        print(csr)</div><div class="line">        return csr</div><div class="line"></div><div class="line">    def get_cert(self):</div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line">        result = pool.apply_async(self.__get_cert,())</div><div class="line">        command = &#39;ace hal dha get_field 0x202\r\n&#39;</div><div class="line">        self.write_to_serial(command, self.delay_sec)</div><div class="line">        cert = result.get(timeout=2)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line">        return cert</div><div class="line"></div><div class="line">    def __init_keygen(self):</div><div class="line">        retVal = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            if response.startswith(&#39;retval:&#39;):</div><div class="line">                print(response)</div><div class="line">                retVal = int(response.strip(&#39;retval:&#39;))</div><div class="line">                if retVal !=0:</div><div class="line">                    print(&quot;WARNING: Key pair is already initialized. Have you tried the provisioning earlier as well? Err code:&quot;, retVal)</div><div class="line">                break</div><div class="line"></div><div class="line">    def __get_csr(self):</div><div class="line">        csr = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            if response.startswith(&#39;-----BEGIN CERTIFICATE REQUEST----&#39;):</div><div class="line">                csr += response</div><div class="line">                break</div><div class="line">            elif response.strip():</div><div class="line">                sys.stdout.write(response)</div><div class="line"></div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            csr += response</div><div class="line">            if response.startswith(&#39;-----END CERTIFICATE REQUEST----&#39;):</div><div class="line">                break</div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            if response.startswith(&#39;retval:&#39;):</div><div class="line">                print(response)</div><div class="line">                break</div><div class="line"></div><div class="line">        return csr</div><div class="line"></div><div class="line">    def __get_cert(self):</div><div class="line">        cert = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            if response.startswith(&#39;-----BEGIN CERTIFICATE----&#39;):</div><div class="line">                cert += response</div><div class="line">                break</div><div class="line"></div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            if response.startswith(&#39;retval:&#39;):</div><div class="line">                break</div><div class="line">            cert += response</div><div class="line"></div><div class="line"></div><div class="line">        return cert</div><div class="line"></div><div class="line">    def __get_res(self):</div><div class="line">        res = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line">            if response.strip():</div><div class="line">                print(response)</div><div class="line">            if &#39;retval: &#39; in response:</div><div class="line">                value = int(re.search(r&#39;\d+&#39;, response).group())</div><div class="line">                #if it&#39;s not 0 continue printing logs for easier debugging, since you failed anways and let it time out</div><div class="line">                if (value == 0):</div><div class="line">                    res = response</div><div class="line">                    break</div><div class="line">                else:</div><div class="line">                    print(&quot;ERROR: Writing signed cert is failed. Err code: &quot;,value)</div><div class="line">        return res</div><div class="line"></div><div class="line">    def __get_all_responses(self):</div><div class="line">        response = self.serial_port.readline().lstrip()</div><div class="line">        while response != &#39;&#39;:</div><div class="line">            sys.stdout.write(response)</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">class device_provisioner(device_cli):</div><div class="line"></div><div class="line">    def provision_device_info(self, device_serial, device_type, ffs_pid, dss_pub_key):</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Provisioning Device Info\n&#39;)</div><div class="line">        self.set_device_info(device_serial, device_type, ffs_pid, dss_pub_key)</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Done\n&#39;)</div><div class="line"></div><div class="line">    def save_csr(self):</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Generating CSR\n&#39;)</div><div class="line">        csr =  self.get_csr()</div><div class="line">        fileName = &#39;csr.pem&#39;</div><div class="line">        self.__write_to_file(fileName, csr)</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Done (&#39;+ fileName + &#39; created)\n&#39;)</div><div class="line">        return csr</div><div class="line"></div><div class="line">    def save_cert(self):</div><div class="line">        cert =  self.get_cert()</div><div class="line">        fileName = &#39;cert.pem&#39;</div><div class="line">        self.__write_to_file(fileName, cert)</div><div class="line">        print (fileName + &quot; created&quot;)</div><div class="line">        return cert</div><div class="line"></div><div class="line"></div><div class="line">    def __write_to_file(self, file_name, data):</div><div class="line">        with open(file_name, &#39;w&#39;) as write_file:</div><div class="line">            write_file.write(data)</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def parse_inputs():</div><div class="line">    try:</div><div class="line">        parser = argparse.ArgumentParser(</div><div class="line">            formatter_class=argparse.RawTextHelpFormatter,</div><div class="line">            epilog=&#39;\n================================================================================\n&#39;,</div><div class="line">            usage=&#39;&#39;&#39;provision.py [-h] -p &lt;COM_PORT&gt; -c COMMAND [-f CERT_FILE]</div><div class="line">                    [-x DEVICE_INFO_CONFIG]</div><div class="line">                   \r\n================================================================================</div><div class="line">                     \r=============== Please follow below steps to provision a device ================</div><div class="line">                     \r================================================================================</div><div class="line">                     \r\n  1. Create a developer account (if you do not already have one) on developer.amazon.com.</div><div class="line">                     \r  2. Go to https://developer.amazon.com/acs-devices/console.</div><div class="line">                     \r  3. Cilck on the &quot;Manage&gt;Device Certificates&quot; link on the sidebar.</div><div class="line">                     \r  4. Click &quot;Request new DSN button&quot;. (You can have up to 5 DSNs per device type)</div><div class="line">                     \r  5. Click &quot;Get New Certificate&quot; to the right of the DSN you want a certificate for.</div><div class="line">                     \r  6. Download the Device Data JSON file and put it at the same directory as this script.</div><div class="line">                     \r  7. In your terminal, run ./provision.py -p &lt;COM-port&gt; -c provision -x &lt;JSON-filename&gt;.</div><div class="line">                     \r\n     For example, ./provision.py -p /dev/ttyUSB0 -c provision -x device-info</div><div class="line">                     \r\n  8. Then, run ./provision.py -p &lt;COM-port&gt; -c get_csr. A csr.pem will be generated.</div><div class="line">                     \r\n     This is device hardware specific. It needs to be regenerated if device flash data is erased.</div><div class="line">                     \r\n     For example, ./provision.py -p /dev/ttyUSB0 -c get_csr</div><div class="line">                     \r\n  9. Copy and paste the CSR into the text box in the &quot;Get New Certificate&quot; window.</div><div class="line">                     \r     and click &quot;Submit&quot;. Wait a few seconds. The button should update to &quot;Download Certificate&quot;.</div><div class="line">                     \r 10. Put the downloaded Certificate at the same directory as this script.</div><div class="line">                     \r 11. In your terminal, run ./provision.py &lt;COM-port&gt; -c save_cert -f &lt;Certificate-filename&gt;</div><div class="line">                     \r\n     For example, ./provision.py -p /dev/ttyUSB0 -c save_cert -f XYZ.pem</div><div class="line">                     \r\n================================================================================&#39;&#39;&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-p&#39;, &#39;--port&#39;,</div><div class="line">            dest=INPUT_PORT,</div><div class="line">            required=True,</div><div class="line">            type=str,</div><div class="line">            help=&#39;COM port that Acorn is connected to&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-c&#39;,</div><div class="line">            &#39;--command&#39;,</div><div class="line">            dest=INPUT_COMMAND,</div><div class="line">            required=True,</div><div class="line">            type=str,</div><div class="line">            help=&#39;&#39;&#39;Commands for this script:</div><div class="line">            python provision.py -p &lt;comport&gt; -c &lt;provision | get_csr | save_cert&gt; -x &lt;device_info_config_file_path&gt;</div><div class="line">            -c option meanings:</div><div class="line">            provision: provision the device with the device info config file</div><div class="line">            get_csr: use to get the csr from the device to sign it in the portal then use save_cert</div><div class="line">            save_cert: use with fileName of the signed certificate from the csr from get_csr</div><div class="line">            get_device_info: get the device info and print it out</div><div class="line">            &#39;&#39;&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-f&#39;,</div><div class="line">            &#39;--cert_file&#39;,</div><div class="line">            dest=INPUT_CERT_FILE,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;The file of the signed certificate to load to device.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-x&#39;,</div><div class="line">            &#39;--device_info_config&#39;,</div><div class="line">            dest=INPUT_DEVICE_INFO_CONFIG,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;The file path of device_info config.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-s&#39;,</div><div class="line">            &#39;--speed&#39;,</div><div class="line">            dest=INPUT_SPEED,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            default=&#39;normal&#39;,</div><div class="line">            choices=[&#39;normal&#39;, &#39;slow&#39;],</div><div class="line">            help=&#39;Speed to run script.  Default is %(default)s.  &#39;</div><div class="line">            &#39;If device is dropping bytes or part of commands send from PC, use -s slow. to insert a delay.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-dms&#39;,</div><div class="line">            &#39;--delay_ms&#39;,</div><div class="line">            dest=INPUT_DELAY_MS,</div><div class="line">            required=False,</div><div class="line">            type=int,</div><div class="line">            default=10,</div><div class="line">            choices=range(1,1000),</div><div class="line">            metavar=&#39;int(1, 1000)&#39;,</div><div class="line">            help=&#39;Millisecond delay to insert if --speed is set to slow.  Default is %(default)s ms.&#39;)</div><div class="line">        kwargs = vars(parser.parse_args())</div><div class="line">        # Remove None values</div><div class="line">        kwargs = {k: v for k, v in kwargs.items() if v}</div><div class="line">    except Exception as e:</div><div class="line">        print(str(e))</div><div class="line"></div><div class="line">    return kwargs</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def get_from_file(file_name):</div><div class="line">    content = &#39;&#39;</div><div class="line">    with open(file_name) as read_file:</div><div class="line">        content = read_file.readlines()</div><div class="line">    return &#39;&#39;.join(content)</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def get_device_info_config(config_file):</div><div class="line">    print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Parsing Device Info\n&#39;)</div><div class="line">    try:</div><div class="line">        with open(config_file) as f:</div><div class="line">            device_info_config = json.load(f)</div><div class="line">            try:</div><div class="line">                print(&#39;device_serial = &#39; + device_info_config[&quot;device_serial&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid device_serial\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;device_type = &#39; + device_info_config[&quot;device_type&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid device_type\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;ffs_pid = &#39; + device_info_config[&quot;ffs_pid&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid ffs_pid\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;dss_pub_key = &#39; + device_info_config[&quot;dss_pub_key&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid dss_pub_key\n\n&#39;)</div><div class="line">                return</div><div class="line">            print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Done\n&#39;)</div><div class="line">            return device_info_config</div><div class="line">    except:</div><div class="line">        print(&#39;Invalid device info config: &#39; + config_file + &#39;\n&#39;)</div><div class="line">        print(&#39;Please pass the correct one in with -x\n\n&#39;)</div><div class="line">        return</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def provision_device_info(provisioner, device_serial, device_type, ffs_pid, dss_pub_key):</div><div class="line">    provisioner.provision_device_info(device_serial, device_type, ffs_pid, dss_pub_key)</div><div class="line"></div><div class="line">def write_device_csr_from_file(provisioner, fileName):</div><div class="line">    provisioner.set_cert_from_file(fileName)</div><div class="line"></div><div class="line">def save_device_csr(provisioner):</div><div class="line">    provisioner.save_csr()</div><div class="line"></div><div class="line">def save_device_cert(provisioner):</div><div class="line">    provisioner.save_cert()</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def execute(serial_port, kwargs):</div><div class="line">    try:</div><div class="line">        command =  kwargs[INPUT_COMMAND]</div><div class="line">        speed =  kwargs[INPUT_SPEED]</div><div class="line">        delay_ms = 0.0;</div><div class="line">        if speed == &#39;slow&#39;:</div><div class="line">            delay_ms =  kwargs[INPUT_DELAY_MS]</div><div class="line">        provisioner = device_provisioner(serial_port, delay_ms)</div><div class="line"></div><div class="line">        if (INPUT_DEVICE_INFO_CONFIG in kwargs):</div><div class="line">            device_info_config = get_device_info_config(kwargs[INPUT_DEVICE_INFO_CONFIG])</div><div class="line">            device_serial = device_info_config[&quot;device_serial&quot;]</div><div class="line">            device_type = device_info_config[&quot;device_type&quot;]</div><div class="line">            ffs_pid = device_info_config[&quot;ffs_pid&quot;]</div><div class="line">            dss_pub_key = device_info_config[&quot;dss_pub_key&quot;]</div><div class="line"></div><div class="line">        if command == &#39;provision&#39;:</div><div class="line">            provision_device_info(provisioner, device_serial, device_type, ffs_pid, dss_pub_key),</div><div class="line">        elif command == &#39;get_csr&#39;:</div><div class="line">            save_device_csr(provisioner),</div><div class="line">        elif command == &#39;save_cert&#39;:</div><div class="line">            if (INPUT_CERT_FILE not in kwargs):</div><div class="line">                print (&quot;Missing file of signed cert please pass in with -f&quot;)</div><div class="line"></div><div class="line">            fileName = kwargs[INPUT_CERT_FILE]</div><div class="line">            write_device_csr_from_file(provisioner, fileName),</div><div class="line">        else:</div><div class="line">            print(&quot;Invalid command: &quot; + command)</div><div class="line"></div><div class="line">    except:</div><div class="line">        print(&#39;\r\n&#39;)</div><div class="line"></div><div class="line">################################################################################</div><div class="line">def main():</div><div class="line">    kwargs = parse_inputs()</div><div class="line">    try:</div><div class="line">        serial_port = serial.Serial(</div><div class="line">            port = kwargs[INPUT_PORT],</div><div class="line">            baudrate = 115200,</div><div class="line">            timeout = 0.2,</div><div class="line">            xonxoff = False,</div><div class="line">            rtscts = False,</div><div class="line">            dsrdtr = False,</div><div class="line">            writeTimeout = 2</div><div class="line">        )</div><div class="line">        execute(serial_port, kwargs)</div><div class="line"></div><div class="line">    except Exception as e:</div><div class="line">        print(type(e))</div><div class="line">        print(str(e))</div><div class="line">    finally:</div><div class="line">        if serial_port:</div><div class="line">            serial_port.close()</div><div class="line"></div><div class="line">################################################################################</div><div class="line"># don&#39;t execute if imported</div><div class="line">if __name__ == &#39;__main__&#39;:</div><div class="line">    main()</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
