<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACS: IOT LL HAL Assisted Testing with Raspberry Pi 3</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ACS
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__LLHAL__ASTRP3__TEST.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">IOT LL HAL Assisted Testing with Raspberry Pi 3<div class="ingroups"><a class="el" href="group__ACS__CORE__DOCS.html">ACS Core Docs</a> &raquo; <a class="el" href="group__TESTING__GUIDE.html">Testing Guides</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for IOT LL HAL Assisted Testing with Raspberry Pi 3:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__LLHAL__ASTRP3__TEST.png" border="0" alt="" usemap="#group____LLHAL____ASTRP3____TEST"/>
<map name="group____LLHAL____ASTRP3____TEST" id="group____LLHAL____ASTRP3____TEST">
<area shape="rect" id="node1" href="group__TESTING__GUIDE.html" title="Testing Guides" alt="" coords="5,13,116,39"/>
</map>
</td></tr></table></center>
</div>
<p><b>Version Number:</b> 1.0</p>
<ul>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s1">Introduction</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s2">Set up your Local Network and Wireless Connectivity</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s3">Enable SSH</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s4">Install Packages</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s5">IP Address of Raspberry Pi</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s6">GPIO Pinout Diagram</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7">Assisted Test Setup with Raspberry Pi</a><ul>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-1">IOT LL HAL Assisted Test -- ADC Test</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-2">IOT LL HAL Assisted Test -- GPIO Test</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-3">IOT LL HAL Assisted Test -- PWM Test</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-4">IOT LL HAL Assisted Test -- SPI Master Test</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-5">IOT LL HAL Assisted Test -- Temperature Sensor Test</a></li>
<li><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-6">IOT LL HAL Assisted Test -- USB Interrupt Device Test</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="llhalast_s1"></a>
Introduction</h1>
<p>This guide describes how to set up RP3 for assisted tests for IOT LL HAL.</p>
<p><b>Links for RP3 Kit and Accessories</b></p>
<ul>
<li>RP3 : <a href="https://www.amazon.com/gp/product/B07BC6WH7V/ref=ppx_yo_dt_b_asin_title_o07_s00?ie=UTF8&psc=1">https://www.amazon.com/gp/product/B07BC6WH7V/ref=ppx_yo_dt_b_asin_title_o07_s00?ie=UTF8&amp;psc=1</a></li>
<li>Raspbian OS : <a href="https://www.amazon.com/gp/product/B00NUELAXO/ref=ppx_yo_dt_b_asin_title_o06_s00?ie=UTF8&psc=1">https://www.amazon.com/gp/product/B00NUELAXO/ref=ppx_yo_dt_b_asin_title_o06_s00?ie=UTF8&amp;psc=1</a></li>
</ul>
<h1><a class="anchor" id="llhalast_s2"></a>
Set up your Local Network and Wireless Connectivity</h1>
<ul>
<li>Make sure your Raspberry Pi is properly set up and connected. If you are using wireless networking, this can be enabled via the desktop's user interface or using command line.</li>
<li>If you are not using wireless connectivity, plug your Raspberry Pi directly into the router.</li>
<li>You will need to note down the IP address of your Pi in order to connect to it later. Using the ifconfig command will display information about the current network status, including the IP address, or you can use hostname -I to display the IP addresses associated with the device.</li>
</ul>
<h1><a class="anchor" id="llhalast_s3"></a>
Enable SSH</h1>
<p>As of the November 2016 release, Raspbian has the SSH server disabled by default. It can be enabled manually from the desktop:</p>
<ol type="1">
<li>Launch Raspberry Pi Configuration from the Preferences menu.</li>
<li>Navigate to the Interfaces tab.</li>
<li>Select Enabled next to SSH.</li>
<li>Click OK.</li>
</ol>
<p>Alternatively, raspi-config can be used in the terminal:</p>
<ol type="1">
<li>Enter sudo raspi-config in a terminal window.</li>
<li>Select Interfacing Options.</li>
<li>Navigate to and select SSH.</li>
<li>Choose Yes.</li>
<li>Select Ok.</li>
<li>Choose Finish.</li>
</ol>
<p>Alternatively, use <code>systemctl</code> to start the service:</p>
<div class="fragment"><div class="line">sudo systemctl enable ssh</div><div class="line">sudo systemctl start ssh</div></div><!-- fragment --><p>After ssh is enabled, remote login once to add ip into known host.</p>
<h1><a class="anchor" id="llhalast_s4"></a>
Install Packages</h1>
<p>Install Python and other Packages: </p><div class="fragment"><div class="line">sudo apt-get install python3-pip.</div><div class="line">python -m pip install pyserial</div><div class="line">sudo apt install python3-gpiozero</div></div><!-- fragment --><h1><a class="anchor" id="llhalast_s5"></a>
IP Address of Raspberry Pi</h1>
<div class="fragment"><div class="line">ifconfig or hostname -I</div><div class="line">ssh pi@&lt;IP Address&gt;</div></div><!-- fragment --><h1><a class="anchor" id="llhalast_s6"></a>
GPIO Pinout Diagram</h1>
<p>A handy reference can be accessed on the Raspberry Pi by opening a terminal window and running the command pinout. This tool is provided by the <a href="https://gpiozero.readthedocs.io/en/stable/">GPIO Zero Python library</a>, which is installed by default on the Raspbian desktop image. It can be called out by </p><div class="fragment"><div class="line">pinout</div></div><!-- fragment --><h1><a class="anchor" id="llhalast_s7"></a>
Assisted Test Setup with Raspberry Pi</h1>
<p><a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-1">IOT LL HAL Assisted Test -- ADC Test</a> | <a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-2">IOT LL HAL Assisted Test -- GPIO Test</a> | <a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-3">IOT LL HAL Assisted Test -- PWM Test</a> | <a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-4">IOT LL HAL Assisted Test -- SPI Master Test</a> | <a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-5">IOT LL HAL Assisted Test -- Temperature Sensor Test</a> | <a class="el" href="group__LLHAL__ASTRP3__TEST.html#llhalast_s7-6">IOT LL HAL Assisted Test -- USB Interrupt Device Test</a></p>
<h1><a class="anchor" id="llhalast_s7-1"></a>
IOT LL HAL Assisted Test -- ADC Test</h1>
<p><b>Test setup</b></p>
<ul>
<li>Adafruit MCP4725 is used as DAC. <a href="https://www.amazon.com/gp/product/B00SK8MBXI/ref=ppx_yo_dt_b_asin_title_o01_s00?ie=UTF8&psc=1">https://www.amazon.com/gp/product/B00SK8MBXI/ref=ppx_yo_dt_b_asin_title_o01_s00?ie=UTF8&amp;psc=1</a></li>
<li>The DAC is controlled by I2C. RPI PIN 3 (GPIO2) and PIN 5 (GPIO3) are I2C.1 SDA and SCL, respectively. The output of DAC is wired to the ADC pin of DUT.</li>
</ul>
<p><b>Test content</b> The DAC is set to four different digital inputs. For each input, DUT samples five times and takes average. The host converts input with reference voltage and compares with the ADC reading.</p>
<p><b>Individual test command</b> </p><div class="fragment"><div class="line">./test_iot_adc_test.py -i &lt;pi_ip&gt; -s &lt;pi_pwd&gt; -l &lt;pi_login&gt; -p &lt;serial&gt;</div></div><!-- fragment --><p><b>Test Output</b></p>
<p>If the test runs successfully, the pass result will be printed in the console:</p><ul>
<li>test_IotAdcPrintReadSample : Pass</li>
</ul>
<p>A test_result.csv is also generated for later reference.</p>
<h1><a class="anchor" id="llhalast_s7-2"></a>
IOT LL HAL Assisted Test -- GPIO Test</h1>
<p><b>Test setup</b></p>
<p>The GPIO tests hardware consists of three parts:</p>
<ul>
<li>DUT</li>
<li>RPI</li>
<li>A voltage translator which is used for input tests in case the DUT is on 1.8v.</li>
</ul>
<p>Note the following:</p><ul>
<li>The output pin on the DUT is wired directly to PIN 40 (GPIO21) of RPI, since 1.8v is enough to trigger RPI GPIO and pull up resistor on the voltage translator invalidates test_AssistedIotGpioModeWritePushPullTrue test.</li>
<li>The input pin on the DUT is wired to PIN 38 (GPIO20) of RPI through a voltage translator.</li>
<li>Voltage translator needs voltage supply from two sides.</li>
<li>The voltage translator is found here <a href="https://www.sparkfun.com/products/12009">https://www.sparkfun.com/products/12009</a>.</li>
</ul>
<p><b>Test content</b> For the output tests, RPI reads the voltage level on the DUT pin and saves it on a file. The host gets the file from RPI and verifies the result.</p>
<p>The input test DUT reads the voltage level on the RPI pin and verifies it. The host gets the result from console.</p>
<p>Tests list:</p><ul>
<li>test_AssistedIotGpioModeWritePushPullTrue : GPIO output high in push pull mode.</li>
<li>test_AssistedIotGpioModeWritePushPullFalse : GPIO output low in push pull mode.</li>
<li>test_AssistedIotGpioModeWriteOpenDrainFalse : GPIO output low in open drain mode.</li>
<li>test_AssistedIotGpioModeWriteOpenDrainTrue : GPIO output high in open drain mode.</li>
<li>test_AssistedIotGpioModeReadTrue : GPIO input reading high.</li>
<li>test_AssistedIotGpioModeReadFalse : GPIO input reading low.</li>
</ul>
<p><b>Individual test command</b> </p><div class="fragment"><div class="line">./test_iot_gpio_test.py -i &lt;pi_ip&gt; -s &lt;pi_pwd&gt; -l &lt;pi_login&gt; -p &lt;serial&gt;</div></div><!-- fragment --><p><b>Test output</b></p>
<p>If the test runs successfully, the pass result will be printed in the console:</p><ul>
<li>test_AssistedIotGpioModeWritePushPullTrue : Pass</li>
<li>test_AssistedIotGpioModeWritePushPullFalse : Pass</li>
<li>test_AssistedIotGpioModeWriteOpenDrainFalse : Pass</li>
<li>test_AssistedIotGpioModeWriteOpenDrainTrue : Pass</li>
<li>test_AssistedIotGpioModeReadTrue : Pass</li>
<li>test_AssistedIotGpioModeReadFalse : Pass</li>
</ul>
<p>A test_result.csv is also generated for later reference.</p>
<h1><a class="anchor" id="llhalast_s7-3"></a>
IOT LL HAL Assisted Test -- PWM Test</h1>
<p><b>Test setup</b></p>
<ul>
<li>PWM test can use the same voltage translator as GPIO tests if it is needed.</li>
<li>The input pin on the RPI is pin 7(GPIO 4) which is wired to DUT PWM output.</li>
<li>The output pin on the RPI is pin 38(GPIO 20) which is wired to DUT PWM input capture.</li>
</ul>
<p><b>Test content</b></p><ul>
<li>There is only one assisted test. Both DUT and RPI generate and capture PWM at the same time. DUT prints PASS to console if it gets right PWM input. RPI samples PWM frequency periodically and passes to host afterwards.</li>
<li>The PWM frequency is 1000Hz. The test lasts for 5 seconds.</li>
</ul>
<p><b>Individual test command</b> </p><div class="fragment"><div class="line">./test_iot_pwm_test.py -i &lt;pi_ip&gt; -s &lt;pi_pwd&gt; -l &lt;pi_login&gt; -p &lt;serial&gt;</div></div><!-- fragment --><p><b>Test output</b></p>
<p>If the test runs successfully, the pass result will be printed in the console:</p><ul>
<li>test_IotPwmAccuracy : Pass</li>
</ul>
<p>A test_result.csv is also generated for later reference</p>
<h1><a class="anchor" id="llhalast_s7-4"></a>
IOT LL HAL Assisted Test -- SPI Master Test</h1>
<p><b>Test setup</b></p>
<ul>
<li>The SPI master assisted test uses a pyboard as SPI slave instead of Raspberry Pi. Click <a href="https://www.digikey.com/product-detail/en/adafruit-industries-llc/2390/1528-1565-ND/5824409">here</a>. The MicroPython v1.10 is preinstalled on the device.</li>
<li>The voltage translator used is <a href="https://www.digikey.com/product-detail/en/sparkfun-electronics/BOB-11771/1568-1208-ND/5673794">here</a>. A different voltage translator is used to handle faster signals.</li>
<li>SPI 2 on the pyboard is used as slave. It is also controlled by Ubuntu host through serial port.</li>
<li>CS: Chip select on the pyboard is hard coded as software select in the driver level. It cannot be reconfigured without modifying the firmware, so the pin does not need to be connected.</li>
<li>SCK, MISO, MOSI are pin Y6, Y7 and Y8 respectively.</li>
</ul>
<p><b>Test content</b></p><ul>
<li>For the write sync/async tests, DUT sends 16 random generated bytes to slave. Both DUT and slave prints byte to serial for host to compare.</li>
<li>For the read sync/async tests, slave sends 16 random generated bytes to dut. Both DUT and slave prints byte to serial for host to compare.</li>
<li>For the transfer sync/async tests, both DUT and slave send 8 random generated bytes to the other side. Both DUT and slave print received and generated bytes to serial for host to compare.</li>
<li>If the test is failed, a reset of pyboard is suggested.</li>
</ul>
<p><b>Individual test command</b> </p><div class="fragment"><div class="line">./test_iot_spi_master_test.py -p &lt;dut_serial&gt;</div></div><!-- fragment --><p> Info about Raspberry pi is not needed, but it will not break the test if included.</p>
<p><b>Test output</b></p>
<p>If the test runs successfully, the pass result will be printed in the console:</p><ul>
<li>test_IotSPI_WriteSyncAssisted : Pass</li>
<li>test_IotSPI_ReadSyncAssisted : Pass</li>
<li>test_IotSPI_TransferSyncAssisted : Pass</li>
<li>test_IotSPI_WriteAsyncAssisted : Pass</li>
<li>test_IotSPI_ReadAsyncAssisted : Pass</li>
<li>test_IotSPI_TransferAsyncAssisted : Pass</li>
</ul>
<p>A test_result.csv is also generated for later reference.</p>
<h1><a class="anchor" id="llhalast_s7-5"></a>
IOT LL HAL Assisted Test -- Temperature Sensor Test</h1>
<p><b>Test setup</b></p>
<p>The test requires an external temperature sensor as reference. Adafruit MCP9808 is used.https://www.amazon.com/gp/product/B00OKCQX96/ref=ppx_yo_dt_b_asin_title_o07_s00?ie=UTF8&amp;psc=1</p>
<p><b>Test content</b> The test samples each sensor 5 times and compares with average.</p>
<p><b>Individual test command</b> </p><div class="fragment"><div class="line">./test_iot_tsensor_test.py -i &lt;pi_ip&gt; -s &lt;pi_pwd&gt; -l &lt;pi_login&gt; -p &lt;serial&gt;</div></div><!-- fragment --><p><b>Test output</b> If the test runs successfully, the pass result will be printed in the console:</p><ul>
<li>test_IotTsensorTemp: Pass</li>
</ul>
<p>A test_result.csv is also generated for later reference.</p>
<h1><a class="anchor" id="llhalast_s7-6"></a>
IOT LL HAL Assisted Test -- USB Interrupt Device Test</h1>
<p><b>Test setup</b></p>
<p>The USB host is the host Ubuntu. pyusb python library needs to be installed </p><div class="fragment"><div class="line">pip install pyusb</div></div><!-- fragment --><p><b>Test content</b> The tests start with attach and then does write/read &ndash; sync/async. Detach the device at the end of test. Both read and write tests transfer 16 bytes of random bytes and verified by Ubuntu host.</p>
<p><b>Individual test command</b> </p><div class="fragment"><div class="line">sudo ./test_iot_usb_device_test.py -p &lt;serial&gt;</div></div><!-- fragment --><p><b>Run script without root</b></p><ul>
<li>Add the rule below into /etc/udev/rules.d/xx-my-rule.rules SUBSYSTEM=="usb", ATTR{idVendor}=="(device vid)", ATTR{idProduct}=="(device pid)", MODE="666"</li>
<li>And then run <div class="fragment"><div class="line">sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</div></div><!-- fragment --></li>
</ul>
<p><b>Test Output</b> If the test runs successfully, the pass result will be printed in the console:</p><ul>
<li>test_IotUsbDeviceHidAttachAssisted : Pass</li>
<li>test_IotUsbDeviceWriteSyncAssisted : Pass</li>
<li>test_IotUsbDeviceWriteAsyncAssisted : Pass</li>
<li>test_IotUsbDeviceReadAsyncAssisted : Pass</li>
<li>test_IotUsbDeviceReadSyncAssisted : Pass</li>
<li>test_IotUsbDeviceHidDetachAssisted : Pass</li>
</ul>
<p>A test_result.csv is also generated for later reference. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
