<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACS: Raspberry Pi Quick Start Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ACS
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__RPI__QUICK__START__GUIDE.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Raspberry Pi Quick Start Guide<div class="ingroups"><a class="el" href="group__ACS__CORE__DOCS.html">ACS Core Docs</a> &raquo; <a class="el" href="group__QUICK__START__GUIDE.html">Quick Start Guides</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for Raspberry Pi Quick Start Guide:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__RPI__QUICK__START__GUIDE.png" border="0" alt="" usemap="#group____RPI____QUICK____START____GUIDE"/>
<map name="group____RPI____QUICK____START____GUIDE" id="group____RPI____QUICK____START____GUIDE">
<area shape="rect" id="node2" href="group__QUICK__START__GUIDE.html" title="Quick Start Guides" alt="" coords="5,13,139,39"/>
</map>
</td></tr></table></center>
</div>
<ul>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section1">Introduction</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section2">Requirements</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section3">Step 1: Set up Raspberry Pi</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section4">Step 2: Download ACS and set up your build machine</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section5">Step 3: Install Raspberry Pi packages</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section6">Step 4: Test microphone and speakers on RPi</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section7">Step 5: Build / Install ACS on Ubuntu</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section8">Step 6: Provision your device for FFS</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section9">Step 7: Use the FFS app to configure your device</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section10">Step 8: Run AVS Sample app</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section11">Step 9: Talk with Alexa</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section12">Step 10: Run Integration Tests</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section13">FAQs / Troubleshooting</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section14">Support</a></li>
<li><a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section15">Appendix : Provisioning Script</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="rpi_section1"></a>
Introduction</h1>
<p>This guide provides step-by-step instructions to set up Amazon Common Software (ACS) for Connected Devices on a Raspberry Pi 4 running <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Buster with Desktop</a>. When finished, you'll have a working sample app to test setup with Frustration Free Setups (FFS) and interactions with Alexa. You will be able to use both Alexa Voice Services (AVS) as well as FFS at the end of this process. You will also be able to modify the sample app provided to add your own code, or create your own applications using the available ACS APIs located <a href="index.html">here</a>.</p>
<hr/>
 <h1><a class="anchor" id="rpi_section2"></a>
Requirements</h1>
<ul>
<li>Raspberry Pi 4 (Recommended) with 1, 2 or 4GB of RAM - Buy a full kit on Amazon - <a href="https://www.amazon.com/CanaKit-Raspberry-1GB-Starter-Kit/dp/B07V4G63M1">Pi 4</a>.</li>
<li>Micro-USB power cable for Raspberry Pi.</li>
<li>Micro SD Card (Minimum 16 GB) - You need an operating system to get started. NOOBS (New Out of the Box Software) is an easy-to-use operating system install manager for Raspberry Pi. The simplest way to get NOOBS is to buy an SD card with NOOBS pre-installed as with the kit above. Alternatively, you can download and install it on your SD card (follow instructions in the next section).</li>
<li>USB 2.0 (Mini) Microphone - Raspberry Pi does not have a built-in microphone; to interact with Alexa you'll need an external one to plug in - <a href="http://amzn.com/B00IR8R7WQ">Buy on Amazon</a>.</li>
<li>External Speaker with 3.5mm audio cable - <a href="http://amzn.com/B007OYAVLI">Buy on Amazon</a>.</li>
<li>USB Keyboard &amp; Mouse.</li>
<li>HDMI Monitor.</li>
<li>Internet connection - Ethernet or WiFi.</li>
<li>(Optional) Serial cable for console access without a network - <a href="http://www.amazon.com/CanaKit-Raspberry-Wireless-Adapter-Dongle/dp/B00GFAN498/">Buy on Amazon</a>.</li>
<li>Linux computer running Ubuntu version 16.04 or higher.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="rpi_section3"></a>
Step 1: Set up Raspberry Pi</h1>
<p>Navigate to: <a href="https://www.raspberrypi.org/downloads/noobs/">https://www.raspberrypi.org/downloads/noobs/</a> for instructions on downloading NOOBS (v. 3.1 or higher) and setting up your Raspberry Pi (see <a href="https://projects.raspberrypi.org/en/projects/raspberry-pi-setting-up">software setup guide</a> link on the page).</p>
<p>Follow all instructions until your Raspberry Pi is running and then follow all menu prompts to set up your configuration (e.g., password, language, keyboard, time zone, etc.).</p>
<p><b>Note:</b> If you have trouble booting the Raspberry Pi and you flashed an SD drive with the NOOBs download, make sure you have put the entire contents of the unzipped NOOBs into the root of the SD drive (not in a folder). If you still have trouble booting, check that the HDMI plug is in the proper port (there are 2 HDMI ports).</p>
<p>The following image shows a typical Raspberry Pi setup.</p>
<div class="image">
<img src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/ace-documentation/pi4a1._CB1576823738_.png" width="55%"/>
</div>
<p>Do the following before moving to the next step:</p>
<ul>
<li>Once the Raspberry Pi boots and you finish setup (including adding a WiFi connection), write down the IP address of your Raspberry Pi by hovering the mouse over the networking icon in the top right.</li>
<li>Enable SSH access, which is needed for future steps. Using the mouse connected to the Raspberry Pi, click on the top left corner of the screen. Select Preferences, Raspberry Pi Configuration, and click the Interfaces tab and then the radio button to enable SSH. Reboot when finished.</li>
<li>(Optional) Test the speaker by navigating to an online site and playing music or a video with sound. If the sound doesn't work, try adjusting the speaker volume in the top right of the Raspberry Pi menu. If you still have issues, make sure you have selected analog for the sound output (right-click on speaker icon). If you are still having trouble playing sound through the speaker, check your wires and try another set of speakers, if available. You must use the 3.5mm audio speaker output. USB speakers are not supported.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="rpi_section4"></a>
Step 2: Download ACS and set up your build machine</h1>
<p>Download the ACS package for Raspberry Pi including AVS and FFS here.</p>
<p><a href="https://developer.amazon.com/acs-devices/console/download/RaspberryPi4">[-DOWNLOAD-]</a></p>
<p>In order to install python3-pip you may need to enable the universe repository. Edit the <code>/etc/apt/sources.list</code> file and add <code>universe</code> to the end of each line. The following example is for Ubuntu 18.04.</p>
<div class="fragment"><div class="line">deb http://archive.ubuntu.com/ubuntu bionic main universe</div><div class="line">deb http://archive.ubuntu.com/ubuntu bionic-security main universe</div><div class="line">deb http://archive.ubuntu.com/ubuntu bionic-updates main universe</div></div><!-- fragment --><p>On your Ubuntu 16.04 or higher computer, install the following packages:</p>
<div class="fragment"><div class="line">sudo apt-get install -y gcc make g++ file libc6-i386 vim git netcat socat cmake build-essential lib32stdc++6 autoconf libtool</div><div class="line">sudo dpkg --add-architecture i386</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install -y make ruby git python3-setuptools python3-pip python3-dev python-dev srecord locales libc6:i386 \  </div><div class="line">libncurses5:i386 libstdc++6:i386 libssl-dev libffi-dev libkrb5-dev cmake sqlite3 libsqlite3-dev bison libcurl4-openssl-dev</div><div class="line">sudo -H pip3 install --upgrade pip</div><div class="line">sudo -H pip3 install python-gssapi requests requests-kerberos pybars3 awscli prettytable intelhex yasm meson</div><div class="line">sudo -H pip3 install ceedling</div><div class="line">-- or if pip3 doesn&#39;t have ceedling --</div><div class="line">sudo gem install ceedling</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="rpi_section5"></a>
Step 3: Install Raspberry Pi packages</h1>
<p>Get the IP address of your Raspberry Pi. Make sure that your Ubuntu machine is connected to the same network as your Raspberry Pi.</p>
<p>On Ubuntu, run the following command in the top-level directory of your extracted tarball package.</p>
<div class="fragment"><div class="line">./setup.sh &lt;raspberry pi ip address&gt;</div></div><!-- fragment --><p>This script does the following:</p>
<ol type="1">
<li>Provides option to authorize Ubuntu host machine for that Raspberry Pi.</li>
<li>Provides option to generate SSH keys, if not created already.</li>
<li>Updates Raspberry Pi and installs required packages.</li>
<li>Sysroot folder is created and packages to cross-compile are pulled from Raspberry Pi to host machine.</li>
</ol>
<p>If you choose <b>No</b> as option for above steps 1 or 2, then you will be prompted to enter a password whenever the script tries to execute a command in Raspberry Pi.</p>
<p>If you get the following error, you can ignore it:</p>
<div class="fragment"><div class="line">symlink has no referent: &quot;/usr/lib/arm-linux-gnueabihf/libmca_common_ofi.so&quot;</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="rpi_section6"></a>
Step 4: Test microphone and speakers on RPi</h1>
<p>Create a file with the following content in <code>/home/pi</code> named <code>.asoundrc</code>. You'll need to view hidden files to see this file once created.</p>
<div class="fragment"><div class="line">pcm.!default {</div><div class="line">  type asym</div><div class="line">  playback.pcm {</div><div class="line">   type plug</div><div class="line">   slave.pcm &quot;hw:0,0&quot;</div><div class="line">  }</div><div class="line">  capture.pcm {</div><div class="line">   type plug</div><div class="line">   slave.pcm &quot;hw:1,0&quot;</div><div class="line"> }    </div><div class="line">}</div></div><!-- fragment --><p>Issue the following command to record a <code>.wav</code> file:</p>
<div class="fragment"><div class="line">sudo apt-get install sox -y &amp;&amp; rec test.wav</div></div><!-- fragment --><p>This command might install some extra audio dependencies. After it finishes, you should see a message indicating that audio is recording. It's working if you see a running minute counter that is incrementing by the second. It looks similar to the following:</p>
<div class="fragment"><div class="line">In: 0.00% 00:00:01 [00:00:00:00] out:0.00M [ | ] clip:0</div></div><!-- fragment --><p>Speak into the microphone to record something. You should see indicators responding to the audio input which means the microphone is recording. If you do not see the indicators moving, you might have microphone issues. If you suspect microphone issues, check all connections first then retry this step with only the <code>rec test.wav</code> command. If this doesn't work, try another microphone, if possible.</p>
<p>To exit the sound test, type <code>CTRL+C</code>.</p>
<p>Play the <code>.wav</code> file:</p>
<div class="fragment"><div class="line">play test.wav</div></div><!-- fragment --><p>If you still have sound output issues, make sure you have selected analog for the sound output (right-click on speaker icon in top right). If you are still having trouble playing sound through the speaker, check your speaker volume, connections and try another set of speakers, if available. The speaker(s) must be connected via the 3.5mm audio jack. USB speakers are not supported.</p>
<hr/>
 <h1><a class="anchor" id="rpi_section7"></a>
Step 5: Build / Install ACS on Ubuntu</h1>
<p><b>Build ACS on Ubuntu</b></p>
<p>On Ubuntu, run the following command in the top-level directory of your extracted tarball package.</p>
<div class="fragment"><div class="line">./build.sh avs rasp</div></div><!-- fragment --><p><b>Install ACS on Raspberry Pi</b></p>
<p>On Ubuntu, run the following command in the same directory as above to install ACS to your Raspberry Pi:</p>
<div class="fragment"><div class="line">./install_build.sh &lt;raspberry pi ip address&gt; -n</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="rpi_section8"></a>
Step 6: Provision your device for FFS</h1>
<p>Before you run the sample app, you must register your product.</p>
<p>First, authorize your account with ACS_RPI_Kit, so that your account can use Alexa services. Click on the link <a href="[https://developer.amazon.com/acs-devices/console/consent?product_id=A3AZYO8UA17CAR&amp;redirect_uri=https%3A%2F%2Fdeveloper.amazon.com%2Facs-devices%2Fconsole]">here</a>.</p>
<p>Go to the ACS portal registration website at this link: <a href="https://developer.amazon.com/acs-devices/console?code=ANzdUzALkWNBCBcEVhKu&amp;scope=alexa%3Aall+alexa%3Avoice_service%3Apre_auth&amp;state=cc242344-49a2-45f3-8cab-a5987292e8a0">https://developer.amazon.com/acs-devices/console</a></p>
<p>Using this page, you will be able to get the data values you need to register your device. Once you have logged in, navigate to the <a href="https://developer.amazon.com/acs-devices/console/manage">Manage Device Certificates</a> page.</p>
<p>Click on the <b>Request New DSN</b> button to pop open the device type submenu, and then click on the <b>Raspberry Pi 4</b> option. You should now see a new row that contains the name of your product (Raspberry Pi 4), a Device Serial Number, and an orange button labeled "Get New Certificate." Click on the <b>Get New Certificate</b> button, and you should see a "Get New Certificate" pop-up that contains three steps. Click on the <b>Download</b> button underneath the first step to receive a JSON file containing the DSN, DT, RPI_PUB_KEY, and CLIENT_ID. Move this JSON file to where your provisioning script, <code>provision.py</code>, is located (see <a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section15">Appendix : Provisioning Script</a>).</p>
<p>Now, run the provisioning <code>provision.py</code> script. This script takes three arguments: an SSH address, a command to execute, and (in some cases) a file name.</p>
<p>Run this script with the SSH address of your Raspberry Pi, the <code>provision</code> command, and the name of the JSON file that you previously downloaded from the portal.</p>
<div class="fragment"><div class="line">./provision.py -ru pi -rip &lt;raspberry pi ip address&gt; -c provision -x &lt;device_info json file&gt;</div></div><!-- fragment --><p>Next, run the script with the SSH address of your Raspberry Pi and the <code>get_csr</code> command. This step will generate a Certificate Signing Request, and create a file called <code>csr.pem</code> where the script is located.</p>
<div class="fragment"><div class="line">./provision.py -ru pi -rip &lt;raspberry pi ip address&gt; -c get_csr</div></div><!-- fragment --><p>Copy the text from this file and paste it into the text-field under step 3 of the "Get New Certificate" pop-up on the ACS portal website, and click submit. After a couple of seconds, the orange <b>Get New Certificate</b> button should change to a green <b>Download Certificate</b> button. Click on this button to download your signed certificate. Move this signed certificate to where your provisioning script is located.</p>
<p>Run the provision script one last time with the SSH address of your Raspberry Pi, the <code>save_cert</code> command, and the name of the signed certificate that you downloaded earlier.</p>
<div class="fragment"><div class="line">./provision.py -ru pi -rip &lt;raspberry pi ip address&gt; -c save_cert -f &lt;Certificate-filename&gt;</div></div><!-- fragment --><p>The program will now validate your signed certificate, and if the certificate is valid, then the program will output <code>Device Registered</code> and will gracefully terminate. You are now ready to move on to the next step.</p>
<hr/>
 <h1><a class="anchor" id="rpi_section9"></a>
Step 7: Use the FFS app to configure your device</h1>
<p>FFS technology simplifies the setup of connected devices by utilizing a peer-assisted model for setup, whereby a device which is connected to the Internet (Provisioner) aids a new device (Provisionee) to get connected to the Internet. FFS not only helps the devices to connect to the Internet but also in many cases makes it ready for use. This includes registering the device to a customer's Amazon account, configuring the device based on account preferences, and connecting it with the Alexa Ecosystem. In this case, when we run the sample app (downloaded in <a class="el" href="group__RPI__QUICK__START__GUIDE.html#rpi_section4">Step 2: Download ACS and set up your build machine</a>), your Raspberry Pi will be the Provisionee, and your mobile phone with the Amazon test app will be the Provisioner.</p>
<p>If you haven't already done so, connect your phone to a WiFi or cellular data network and make sure that Bluetooth functionality is turned on. Next, download the mobile provisioning app for your mobile phone. You will have to install and use a specific FFS-Android app, which can be downloaded here. Note: Only Android is available at this time.</p>
<p><a href="https://developer.amazon.com/acs-devices/console/download/FFSAndroidApp">[-DOWNLOAD-]</a></p>
<p>Now, run the FFS app on the Raspberry Pi device. This app will run through the FFS flow, which involves the following steps.</p>
<ul>
<li>First, the Raspberry Pi will begin to advertise a Bluetooth Low Energy (BLE) connection. The FFS test app on your mobile device should find this BLE advertisment, and initiate a connection.</li>
<li>Once the connection between the RPI and the mobile device has been established, the RPI scans the area for available WiFi networks, and communicates this information back to the mobile device.</li>
<li>Using your mobile device, you will select one of these WiFi networks and enter the password, which will then be communicated back to the Raspberry Pi using the Bluetooth connection.</li>
<li>The FFS app on the Raspberry Pi will then connect to the WiFi network with the provided credentials, interact with Amazon servers, and receive access tokens that allow for communication with AVS endpoints.</li>
<li>While there are many components to this flow, the Raspberry Pi side of the flow is automatically taken care of by the FFS app. Your interactions with this flow, limited to the FFS mobile app, involve initiating the BLE connection, selecting a WiFi network, and entering a password.</li>
</ul>
<p>Refer to <a class="el" href="group__ESP32__QUICK__START__GUIDE.html#esp_section7">Step 5: Use FFS test app to configure your device as Smartlight</a> of the ESP32 Quick Start Guide and after the phrase "Launch FFS test app. Select 'UI based setup activity' on the main menu." This contains illustrations of the FFS mobile app flow.</p>
<hr/>
 <h1><a class="anchor" id="rpi_section10"></a>
Step 8: Run AVS Sample app</h1>
<p>Run AVS Sample app and <a href="https://developer.amazon.com/docs/avs-device-sdk/raspberry-pi.html#run-and-authorize">authorize</a> (see "Run and authorize the sample app").</p>
<div class="fragment"><div class="line">cd /home/pi/rasp_avs_sample_app</div><div class="line">export LD_LIBRARY_PATH=`pwd`/lib</div><div class="line">PA_ALSA_PLUGHW=1 ./SampleApp /home/pi/rasp_dpk_source/AlexaClientSDKConfig.json</div></div><!-- fragment --><p>If an error occurs, add <code>DEBUG9</code> to the command to see more verbose logs: </p><div class="fragment"><div class="line">PA_ALSA_PLUGHW=1 ./SampleApp /home/pi/rasp_dpk_source/AlexaClientSDKConfig.json DEBUG9</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="rpi_section11"></a>
Step 9: Talk with Alexa</h1>
<p>For example:</p>
<ul>
<li><em>Alexa, what time is it?</em></li>
<li><em>Alexa, do you have any pets?</em></li>
<li><em>Alexa, what is the value of pi?</em></li>
</ul>
<p>See this <a href="https://developer.amazon.com/docs/alexa-voice-service/talk-with-alexa.html">link</a> for more information.</p>
<hr/>
 <h1><a class="anchor" id="rpi_section12"></a>
Step 10: Run Integration Tests</h1>
<p>For more information, contact support at: <a href="#" onclick="location.href='mai'+'lto:'+'acs'+'-p'+'rev'+'ie'+'w-s'+'up'+'por'+'t@'+'ama'+'zo'+'n.c'+'om'; return false;">acs-p<span style="display: none;">.nosp@m.</span>revi<span style="display: none;">.nosp@m.</span>ew-su<span style="display: none;">.nosp@m.</span>ppor<span style="display: none;">.nosp@m.</span>t@ama<span style="display: none;">.nosp@m.</span>zon.<span style="display: none;">.nosp@m.</span>com</a></p>
<hr/>
 <h1><a class="anchor" id="rpi_section13"></a>
FAQs / Troubleshooting</h1>
<p>Please refer all feedback and support-related questions to: <a href="#" onclick="location.href='mai'+'lto:'+'acs'+'-p'+'rev'+'ie'+'w-s'+'up'+'por'+'t@'+'ama'+'zo'+'n.c'+'om'; return false;">acs-p<span style="display: none;">.nosp@m.</span>revi<span style="display: none;">.nosp@m.</span>ew-su<span style="display: none;">.nosp@m.</span>ppor<span style="display: none;">.nosp@m.</span>t@ama<span style="display: none;">.nosp@m.</span>zon.<span style="display: none;">.nosp@m.</span>com</a></p>
<p><b>Q:</b> MIC/audio jack is not working with Raspberry PI, but verified sound output is working. I have created the <code>.asoundrc</code> file and have recorded sound, but the play does not output any sound through 3.5mm speaker jack.</p>
<p>A: Try setting Audio Input as "USB Audio Device" and audio output as "Analog". Also check for loose microphone connection. If that doesn't work, try another USB microphone.</p>
<p><b>Q:</b> Receive "error: Libtool library used but 'LIBTOOL' is undefined"</p>
<p>A: Install libtool:</p>
<div class="fragment"><div class="line">sudo apt-get install libtool</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="rpi_section14"></a>
Support</h1>
<p>Please refer all feedback and support-related questions to: <a href="#" onclick="location.href='mai'+'lto:'+'acs'+'-p'+'rev'+'ie'+'w-s'+'up'+'por'+'t@'+'ama'+'zo'+'n.c'+'om'; return false;">acs-p<span style="display: none;">.nosp@m.</span>revi<span style="display: none;">.nosp@m.</span>ew-su<span style="display: none;">.nosp@m.</span>ppor<span style="display: none;">.nosp@m.</span>t@ama<span style="display: none;">.nosp@m.</span>zon.<span style="display: none;">.nosp@m.</span>com</a></p>
<hr/>
 <h1><a class="anchor" id="rpi_section15"></a>
Appendix : Provisioning Script</h1>
<p>Copy script below and name it <code>provision.py</code></p>
<div class="fragment"><div class="line">#!/usr/bin/python</div><div class="line">#</div><div class="line"># Copyright 2019-2020 Amazon.com, Inc. or its affiliates. All rights reserved.</div><div class="line">#</div><div class="line"># AMAZON PROPRIETARY/CONFIDENTIAL</div><div class="line">#</div><div class="line"># You may not use this file except in compliance with the terms and conditions</div><div class="line"># set forth in the accompanying LICENSE.TXT file. This file is a</div><div class="line"># Modifiable File, as defined in the accompanying LICENSE.TXT file.</div><div class="line">#</div><div class="line"># THESE MATERIALS ARE PROVIDED ON AN &quot;AS IS&quot; BASIS. AMAZON SPECIFICALLY</div><div class="line"># DISCLAIMS, WITH RESPECT TO THESE MATERIALS, ALL WARRANTIES, EXPRESS,</div><div class="line"># IMPLIED, OR STATUTORY, INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY,</div><div class="line"># FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT.</div><div class="line">#</div><div class="line"></div><div class="line">from __future__ import print_function</div><div class="line">import argparse</div><div class="line">import serial</div><div class="line">import subprocess</div><div class="line">import time</div><div class="line">import re</div><div class="line">import sys</div><div class="line">import json</div><div class="line">from multiprocessing.pool import ThreadPool</div><div class="line"></div><div class="line">############### CONSTANTS #####################################################</div><div class="line">INPUT_PORT = &#39;comport&#39;</div><div class="line">INPUT_COMMAND = &#39;command&#39;</div><div class="line">INPUT_DEVICE_INFO_CONFIG = &#39;device_info_config&#39;</div><div class="line">INPUT_SPEED = &#39;speed&#39;</div><div class="line">INPUT_DELAY_MS = &#39;delay_ms&#39;</div><div class="line">INPUT_CERT_FILE = &#39;cert_file&#39;</div><div class="line">INPUT_JSON_FILE = &#39;json_file&#39;</div><div class="line">REMOTE_USER = &#39;remote_user&#39;</div><div class="line">REMOTE_IP = &#39;remote_ip&#39;</div><div class="line"></div><div class="line">def convert_ms_to_sec(ms):</div><div class="line">    return (ms/1000.0)</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">class device_cli():</div><div class="line"></div><div class="line">    def __init__(self, interface_handler):</div><div class="line">        self.interface_handler = interface_handler</div><div class="line"></div><div class="line">    def set_device_info(self, device_serial, device_type, ffs_pid, dss_pub_key, client_id):</div><div class="line"></div><div class="line">        command = &#39;ace hal kvs cli -s -k device_serial -v &#39; + device_serial</div><div class="line">        self.interface_handler.write(command)</div><div class="line"></div><div class="line">        command = &#39;ace hal kvs cli -s -k device_type -v &#39; + device_type</div><div class="line">        self.interface_handler.write(command)</div><div class="line"></div><div class="line">        command = &#39;ace hal kvs cli -s -k ffs_pid -v &#39; + ffs_pid</div><div class="line">        self.interface_handler.write(command)</div><div class="line"></div><div class="line">        command = &#39;kv_storage -s -k dss_pub_key -v &#39; + &#39;\&quot;&#39; + dss_pub_key + &#39;\&quot;&#39;</div><div class="line">        self.interface_handler.write(command)</div><div class="line"></div><div class="line">        command = &#39;kv_storage -s -k client_id -v &#39; + client_id</div><div class="line">        self.interface_handler.write(command)</div><div class="line"></div><div class="line">    def set_cert_from_file(self, certFile):</div><div class="line">        cert_pem = get_from_file(certFile)</div><div class="line">        self.set_cert(cert_pem)</div><div class="line"></div><div class="line">    def set_cert(self, cert):</div><div class="line">        cert_lines = cert.splitlines()</div><div class="line">        command = &#39;&#39;</div><div class="line">        for line in cert_lines:</div><div class="line">            command += line</div><div class="line">            command += &#39;\n&#39;</div><div class="line">        totalCommand = &#39;ace hal dha set_cert \&quot;\\\&quot;&#39; + cert + &#39;\&quot;\\\&quot;\r\n&#39;</div><div class="line">        print(totalCommand)</div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line"></div><div class="line">        cmd_response = self.interface_handler.write_with_delay(totalCommand)</div><div class="line">        result = pool.apply_async(self.__get_res, args=(cmd_response,))</div><div class="line"></div><div class="line">        result.get(timeout=5)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line"></div><div class="line">    def get_csr(self):</div><div class="line">        command = &#39;ace hal dha key_gen\r\n&#39;</div><div class="line">        self.interface_handler.write_with_delay(command)</div><div class="line"></div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line">        command = &#39;ace hal dha get_field 0x201\r\n&#39;</div><div class="line">        cmd_response = self.interface_handler.write_with_delay(command)</div><div class="line">        result = pool.apply_async(self.__get_csr, args=(cmd_response,))</div><div class="line">        csr = result.get(timeout=2)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line">        print(csr)</div><div class="line">        return csr</div><div class="line"></div><div class="line">    def get_cert(self):</div><div class="line">        pool = ThreadPool(processes=1)</div><div class="line"></div><div class="line">        command = &#39;ace hal dha get_field 0x202\r\n&#39;</div><div class="line">        cmd_response = self.interface_handler.write_with_delay(command)</div><div class="line">        result = pool.apply_async(self.__get_cert, args=cmd_response)</div><div class="line"></div><div class="line">        cert = result.get(timeout=2)</div><div class="line">        pool.close()</div><div class="line">        pool.join()</div><div class="line">        return cert</div><div class="line"></div><div class="line">    def __get_csr(self, cmd_response):</div><div class="line">        csr = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.interface_handler.getNext(cmd_response)</div><div class="line">            if response.startswith(&#39;-----BEGIN CERTIFICATE REQUEST----&#39;):</div><div class="line">                csr += response</div><div class="line">                break</div><div class="line">            elif response.strip():</div><div class="line">                sys.stdout.write(response)</div><div class="line"></div><div class="line">        while True:</div><div class="line">            response = self.interface_handler.getNext(cmd_response)</div><div class="line">            csr += response</div><div class="line">            if response.startswith(&#39;-----END CERTIFICATE REQUEST----&#39;):</div><div class="line">                break</div><div class="line">        while True:</div><div class="line">            response = self.interface_handler.getNext(cmd_response)</div><div class="line">            if response.startswith(&#39;retval:&#39;):</div><div class="line">                print(response)</div><div class="line">                break</div><div class="line"></div><div class="line">        return csr</div><div class="line"></div><div class="line">    def __get_cert(self, cmd_response):</div><div class="line">        cert = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.interface_handler.getNext(cmd_response)</div><div class="line">            if response.startswith(&#39;-----BEGIN CERTIFICATE----&#39;):</div><div class="line">                cert += response</div><div class="line">                break</div><div class="line"></div><div class="line">        while True:</div><div class="line">            response = self.interface_handler.getNext(cmd_response)</div><div class="line">            if response.startswith(&#39;retval:&#39;):</div><div class="line">                break</div><div class="line">            cert += response</div><div class="line"></div><div class="line"></div><div class="line">        return cert</div><div class="line"></div><div class="line">    def __get_res(self, cmd_response):</div><div class="line">        res = &#39;&#39;</div><div class="line">        while True:</div><div class="line">            response = self.interface_handler.getNext(cmd_response)</div><div class="line">            if response.strip():</div><div class="line">                print(response)</div><div class="line">            if &#39;retval: &#39; in response:</div><div class="line">                value = int(re.search(r&#39;\d+&#39;, response).group())</div><div class="line">                #if it&#39;s not 0 continue printing logs for easier debugging, since you failed anways and let it time out</div><div class="line">                if (value == 0):</div><div class="line">                    res = response</div><div class="line">                    break</div><div class="line"></div><div class="line">        return res</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">class interface_handler():</div><div class="line"></div><div class="line">    def write_with_delay(self, command):</div><div class="line">        pass</div><div class="line"></div><div class="line">    def write(self, command):</div><div class="line">        pass</div><div class="line"></div><div class="line">    def getNext(self, response_iter):</div><div class="line">        pass</div><div class="line"></div><div class="line">#############</div><div class="line"></div><div class="line">class serial_interface_handler(interface_handler):</div><div class="line">    def __init__(self, serial_port, delay_ms):</div><div class="line">        self.serial_port = serial_port</div><div class="line">        self.delay_sec = convert_ms_to_sec(delay_ms)</div><div class="line"></div><div class="line">    def __get_all_responses(self):</div><div class="line">        response = self.serial_port.readline().lstrip()</div><div class="line">        while response != &#39;&#39;:</div><div class="line">            sys.stdout.write(response)</div><div class="line">            response = self.serial_port.readline().lstrip()</div><div class="line"></div><div class="line">    def write_with_delay(self, command):</div><div class="line">        if self.delay_sec == 0.0:</div><div class="line">            self.serial_port.write(command)</div><div class="line">        else:</div><div class="line">            # some devices can&#39;t be write to at normal speed and needs a delay</div><div class="line">            # for these insert a delay between chars</div><div class="line">            for c in command:</div><div class="line">                self.serial_port.write(c.encode())</div><div class="line">                time.sleep(self.delay_sec)</div><div class="line">        return None</div><div class="line"></div><div class="line">    def write(self, command):</div><div class="line">        command += &#39;\r\n&#39;</div><div class="line">        self.serial_port.write(command.encode())</div><div class="line">        self.__get_all_responses()</div><div class="line">        time.sleep(1)</div><div class="line">        return None</div><div class="line"></div><div class="line">    def getNext(self, response_iter):</div><div class="line">        return self.serial_port.readline().lstrip()</div><div class="line"></div><div class="line">#############</div><div class="line"></div><div class="line">class ssh_interface_handler(interface_handler):</div><div class="line">    def __init__(self, remote_user, remote_ip):</div><div class="line">        self.remote_user = remote_user</div><div class="line">        self.remote_ip = remote_ip</div><div class="line">        self.ssh_command = self.get_ssh_command(remote_user, remote_ip)</div><div class="line"></div><div class="line">    def get_ssh_command(self, remote_user, remote_ip):</div><div class="line">        ssh_command = [&#39;ssh&#39;, &#39;-o&#39;, &#39;StrictHostKeyChecking=no&#39;, self.remote_user + &#39;@&#39; + self.remote_ip]</div><div class="line">        return ssh_command</div><div class="line"></div><div class="line">    def shell_cmd(self, cmd):</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        Description:</div><div class="line">            Execute a command on the Shell</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        try:</div><div class="line">            ##Extend the list</div><div class="line">            command = self.ssh_command + [cmd]</div><div class="line">            ##Call the subprocess with final command</div><div class="line">            out = subprocess.check_output(command, stderr=subprocess.STDOUT)</div><div class="line">            return out.rstrip()</div><div class="line">        except subprocess.CalledProcessError as error:</div><div class="line">            print(str(error))</div><div class="line">            return &#39;fail&#39;</div><div class="line">        except Exception as error:</div><div class="line">            print(str(error))</div><div class="line">            sys.exit(1)</div><div class="line"></div><div class="line">    def write_with_delay(self, command):</div><div class="line">        response = self.write(command)</div><div class="line">        return response</div><div class="line"></div><div class="line">    def write(self, command):</div><div class="line">        response = self.shell_cmd(command)</div><div class="line">        if response == &#39;fail&#39;:</div><div class="line">            print(response)</div><div class="line">            return None</div><div class="line">        #Return iterator for iterating line by line over the list created by response data</div><div class="line">        return iter(response.splitlines())</div><div class="line"></div><div class="line">    def getNext(self, response_iter):</div><div class="line">        nextItem = next(response_iter, None)</div><div class="line">        if(nextItem is not None):</div><div class="line">            nextItem += &#39;\n&#39;</div><div class="line">        return nextItem</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">class device_provisioner(device_cli):</div><div class="line"></div><div class="line">    def provision_device_info(self, device_serial, device_type, ffs_pid, dss_pub_key, client_id):</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Provisioning Device Info\n&#39;)</div><div class="line">        self.set_device_info(device_serial, device_type, ffs_pid, dss_pub_key, client_id)</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Done\n&#39;)</div><div class="line"></div><div class="line">    def save_csr(self):</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Generating CSR\n&#39;)</div><div class="line">        csr =  self.get_csr()</div><div class="line">        fileName = &#39;csr.pem&#39;</div><div class="line">        self.__write_to_file(fileName, csr)</div><div class="line">        print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Done (&#39;+ fileName + &#39; created)\n&#39;)</div><div class="line">        return csr</div><div class="line"></div><div class="line">    def save_cert(self):</div><div class="line">        cert =  self.get_cert()</div><div class="line">        fileName = &#39;cert.pem&#39;</div><div class="line">        self.__write_to_file(fileName, cert)</div><div class="line">        print (fileName + &quot; created&quot;)</div><div class="line">        return cert</div><div class="line"></div><div class="line">    def __write_to_file(self, file_name, data):</div><div class="line">        with open(file_name, &#39;w&#39;) as write_file:</div><div class="line">            write_file.write(data)</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def parse_inputs():</div><div class="line">    try:</div><div class="line">        parser = argparse.ArgumentParser(</div><div class="line">            formatter_class=argparse.RawTextHelpFormatter,</div><div class="line">            epilog=&#39;\n================================================================================\n&#39;,</div><div class="line">            usage=&#39;&#39;&#39;provision.py [-h] -p &lt;COM_PORT&gt; -c COMMAND [-f CERT_FILE]</div><div class="line">                    [-x DEVICE_INFO_CONFIG]</div><div class="line">                   \r\n================================================================================</div><div class="line">                     \r=============== Please follow below steps to provision a device ================</div><div class="line">                     \r================================================================================</div><div class="line">                     \r\n  1. Create a developer account (if you do not already have one) on developer.amazon.com.</div><div class="line">                     \r  2. Go to https://developer.amazon.com/acs-connected-devices/console.</div><div class="line">                     \r  3. Cilck on the &quot;Manage&gt;Device Certificates&quot; link on the sidebar.</div><div class="line">                     \r  4. Click &quot;Request new DSN button&quot;. (You can have up to 5 DSNs per device type)</div><div class="line">                     \r  5. Click &quot;Get New Certificate&quot; to the right of the DSN you want a certificate for.</div><div class="line">                     \r  6. Download the Device Data JSON file and put it at the same directory as this script.</div><div class="line">                     \r  7. In your terminal, run ./provision.py -p &lt;COM-port&gt; -c provision -x &lt;JSON-filename&gt;.</div><div class="line">                     \r\n     For example, ./provision.py -p /dev/ttyUSB0 -c provision -x device-info</div><div class="line">                     \r\n  8. Then, run ./provision.py -p &lt;COM-port&gt; -c get_csr. A csr.pem will be generated.</div><div class="line">                     \r\n     For example, ./provision.py -p /dev/ttyUSB0 -c get_csr</div><div class="line">                     \r\n  9. Copy and paste the CSR into the text box in the &quot;Get New Certificate&quot; window.</div><div class="line">                     \r     and click &quot;Submit&quot;. Wait a few seconds. The button should update to &quot;Download Certificate&quot;.</div><div class="line">                     \r 10. Put the downloaded Certificate at the same directory as this script.</div><div class="line">                     \r 11. In your terminal, run ./provision.py &lt;COM-port&gt; -c save_cert -f &lt;Certificate-filename&gt;</div><div class="line">                     \r\n     For example, ./provision.py -p /dev/ttyUSB0 -c save_cert -f XYZ.pem</div><div class="line">                     \r\n================================================================================&#39;&#39;&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-p&#39;, &#39;--port&#39;,</div><div class="line">            dest=INPUT_PORT,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;COM port that Acorn is connected to&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-c&#39;,</div><div class="line">            &#39;--command&#39;,</div><div class="line">            dest=INPUT_COMMAND,</div><div class="line">            required=True,</div><div class="line">            type=str,</div><div class="line">            help=&#39;&#39;&#39;Commands for this script:</div><div class="line">            python provision.py -p &lt;comport&gt; -c &lt;provision | get_csr | save_cert&gt; -x &lt;device_info_config_file_path&gt;</div><div class="line">            -c option meanings:</div><div class="line">            provision: provision the device with the device info config file</div><div class="line">            get_csr: use to get the csr from the device to sign it in the portal then use save_cert</div><div class="line">            save_cert: use with fileName of the signed certificate from the csr from get_csr</div><div class="line">            get_device_info: get the device info and print it out</div><div class="line">            &#39;&#39;&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-f&#39;,</div><div class="line">            &#39;--cert_file&#39;,</div><div class="line">            dest=INPUT_CERT_FILE,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;The file of the signed certificate to load to device.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-rip&#39;,</div><div class="line">            &#39;--remote_ip&#39;,</div><div class="line">            dest=REMOTE_IP,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;Remote device ip for ssh.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-ru&#39;,</div><div class="line">            &#39;--remote_user&#39;,</div><div class="line">            dest=REMOTE_USER,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;Remote device user name for ssh.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-x&#39;,</div><div class="line">            &#39;--device_info_config&#39;,</div><div class="line">            dest=INPUT_DEVICE_INFO_CONFIG,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            help=&#39;The file path of device_info config.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-s&#39;,</div><div class="line">            &#39;--speed&#39;,</div><div class="line">            dest=INPUT_SPEED,</div><div class="line">            required=False,</div><div class="line">            type=str,</div><div class="line">            default=&#39;normal&#39;,</div><div class="line">            choices=[&#39;normal&#39;, &#39;slow&#39;],</div><div class="line">            help=&#39;Speed to run script.  Default is %(default)s.  &#39;</div><div class="line">            &#39;If device is dropping bytes or part of commands send from PC, use -s slow. to insert a delay.&#39;)</div><div class="line">        parser.add_argument(</div><div class="line">            &#39;-dms&#39;,</div><div class="line">            &#39;--delay_ms&#39;,</div><div class="line">            dest=INPUT_DELAY_MS,</div><div class="line">            required=False,</div><div class="line">            type=int,</div><div class="line">            default=10,</div><div class="line">            choices=range(1,1000),</div><div class="line">            metavar=&#39;int(1, 1000)&#39;,</div><div class="line">            help=&#39;Millisecond delay to insert if --speed is set to slow.  Default is %(default)s ms.&#39;)</div><div class="line">        kwargs = vars(parser.parse_args())</div><div class="line">        # Remove None values</div><div class="line">        kwargs = {k: v for k, v in kwargs.items() if v}</div><div class="line"></div><div class="line">        if (INPUT_PORT not in kwargs):</div><div class="line">            if (REMOTE_IP not in kwargs or REMOTE_USER not in kwargs):</div><div class="line">                parser.error(&#39;Please either provide serial port, or remote IP and user name are required&#39;)</div><div class="line">    except Exception as e:</div><div class="line">        print(str(e))</div><div class="line"></div><div class="line">    return kwargs</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def get_from_file(file_name):</div><div class="line">    content = &#39;&#39;</div><div class="line">    with open(file_name) as read_file:</div><div class="line">        content = read_file.readlines()</div><div class="line">    return &#39;&#39;.join(content)</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def get_device_info_config(config_file):</div><div class="line">    print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Parsing Device Info\n&#39;)</div><div class="line">    try:</div><div class="line">        with open(config_file) as f:</div><div class="line">            device_info_config = json.load(f)</div><div class="line">            try:</div><div class="line">                print(&#39;device_serial = &#39; + device_info_config[&quot;device_serial&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid device_serial\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;device_type = &#39; + device_info_config[&quot;device_type&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid device_type\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;ffs_pid = &#39; + device_info_config[&quot;ffs_pid&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid ffs_pid\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;dss_pub_key = &#39; + device_info_config[&quot;dss_pub_key&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid dss_pub_key\n\n&#39;)</div><div class="line">                return</div><div class="line">            try:</div><div class="line">                print(&#39;client_id = &#39; + device_info_config[&quot;client_id&quot;])</div><div class="line">            except:</div><div class="line">                print(&#39;Invalid client_id\n\n&#39;)</div><div class="line">                return</div><div class="line">            print(&#39;\r\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Done\n&#39;)</div><div class="line">            return device_info_config</div><div class="line">    except:</div><div class="line">        print(&#39;Invalid device info config: &#39; + config_file + &#39;\n&#39;)</div><div class="line">        print(&#39;Please pass the correct one in with -x\n\n&#39;)</div><div class="line">        return</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def provision_device_info(provisioner, device_serial, device_type, ffs_pid, dss_pub_key, client_id):</div><div class="line">    provisioner.provision_device_info(device_serial, device_type, ffs_pid, dss_pub_key, client_id)</div><div class="line"></div><div class="line">def write_device_cert_from_file(provisioner, fileName):</div><div class="line">    provisioner.set_cert_from_file(fileName)</div><div class="line"></div><div class="line">def generate_and_save_device_csr(provisioner):</div><div class="line">    provisioner.save_csr()</div><div class="line"></div><div class="line">def save_device_cert(provisioner):</div><div class="line">    provisioner.save_cert()</div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line"></div><div class="line">################################################################################</div><div class="line"></div><div class="line">def execute(provisioner, kwargs):</div><div class="line"></div><div class="line">    command =  kwargs[INPUT_COMMAND]</div><div class="line">    if (INPUT_DEVICE_INFO_CONFIG in kwargs):</div><div class="line">        device_info_config = get_device_info_config(kwargs[INPUT_DEVICE_INFO_CONFIG])</div><div class="line">        device_serial = device_info_config[&quot;device_serial&quot;]</div><div class="line">        device_type = device_info_config[&quot;device_type&quot;]</div><div class="line">        ffs_pid = device_info_config[&quot;ffs_pid&quot;]</div><div class="line">        dss_pub_key = device_info_config[&quot;dss_pub_key&quot;]</div><div class="line">        client_id = device_info_config[&quot;client_id&quot;]</div><div class="line"></div><div class="line">    if command == &#39;provision&#39;:</div><div class="line">        provision_device_info(provisioner, device_serial, device_type, ffs_pid, dss_pub_key, client_id),</div><div class="line">    elif command == &#39;get_csr&#39;:</div><div class="line">        generate_and_save_device_csr(provisioner),</div><div class="line">    elif command == &#39;save_cert&#39;:</div><div class="line">        if (INPUT_CERT_FILE not in kwargs):</div><div class="line">            print (&quot;Missing file of signed cert please pass in with -f&quot;)</div><div class="line"></div><div class="line">        fileName = kwargs[INPUT_CERT_FILE]</div><div class="line">        write_device_cert_from_file(provisioner, fileName),</div><div class="line">    else:</div><div class="line">        print(&quot;Invalid command: &quot; + command)</div><div class="line"></div><div class="line"></div><div class="line">################################################################################</div><div class="line">def main():</div><div class="line">    kwargs = parse_inputs()</div><div class="line">    try:</div><div class="line">        ##If need to use serial</div><div class="line">        serial_port = None</div><div class="line">        provisioner = None</div><div class="line"></div><div class="line">        if (INPUT_PORT in kwargs):</div><div class="line"></div><div class="line">            serial_port = serial.Serial(</div><div class="line">                port = kwargs[INPUT_PORT],</div><div class="line">                baudrate = 115200,</div><div class="line">                timeout = 0.2,</div><div class="line">                xonxoff = False,</div><div class="line">                rtscts = False,</div><div class="line">                dsrdtr = False,</div><div class="line">                writeTimeout = 2</div><div class="line">            )</div><div class="line">            speed = kwargs[INPUT_SPEED]</div><div class="line">            delay_ms = 0.0</div><div class="line">            if speed == &#39;slow&#39;:</div><div class="line">                delay_ms = kwargs[INPUT_DELAY_MS]</div><div class="line">            ##create serial interface handler</div><div class="line">            serial_int_hndlr = serial_interface_handler(serial_port, delay_ms)</div><div class="line">            provisioner = device_provisioner(serial_int_hndlr)</div><div class="line"></div><div class="line">        ##If need to use ssh</div><div class="line">        elif (REMOTE_USER in kwargs and REMOTE_IP in kwargs):</div><div class="line"></div><div class="line">            ##create ssh interface handler</div><div class="line">            ssh_int_hndlr = ssh_interface_handler(kwargs[REMOTE_USER], kwargs[REMOTE_IP])</div><div class="line">            provisioner = device_provisioner(ssh_int_hndlr)</div><div class="line"></div><div class="line">        else:</div><div class="line">            print(&quot;Need to provide either serial port / remote username and ip for ssh&quot;)</div><div class="line">            exit(-1)</div><div class="line"></div><div class="line">        execute(provisioner, kwargs)</div><div class="line">    except Exception as e:</div><div class="line">        print(type(e))</div><div class="line">        print(str(e))</div><div class="line">    finally:</div><div class="line">        if serial_port:</div><div class="line">            serial_port.close()</div><div class="line"></div><div class="line">################################################################################</div><div class="line"># don&#39;t execute if imported</div><div class="line">if __name__ == &#39;__main__&#39;:</div><div class="line">    main()</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
